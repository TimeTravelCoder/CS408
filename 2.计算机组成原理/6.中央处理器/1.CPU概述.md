计算机所有功能通过执行程序完成，程序由若干条指令构成。计算机采用“存储程序”工作方式，即计算机必须能够自动地从主存取出一条条指令执行，专门执行指令的部件就是中央处理器 (Central Processing Unit, CPU)。
处理器中控制指令执行的部件是控制器。控制器可采用硬连线路、微程序设计或两者结合的方式实现。
### 6.1.1 指令执行过程

指令按顺序存放在内存连续单元中，指令地址由 PC (程序计数器) 给出。CPU 取出并执行一条指令的时间称为 **指令周期**，不同指令的指令周期可能不同。
**CPU 执行指令的一般过程 (如图 6.1 所示):**
   ![[image-225.png]]
1.  **指令地址计算 (Instruction Address Calculation):**
    *   **顺序执行时:** 下条指令地址 = 当前 PC + 当前指令长度。
    *   **转移/分支时:** 根据指令操作码和寻址方式决定下条指令地址。
2.  **取指令 (Fetch Instruction):**
    *   需要一次或多次访存。
    *   **定长指令字:** 通常一次访存即可。
    *   **变长指令字:** 可能需要多次访存。
3.  **指令操作码的译码 (Decode Instruction Opcode):**
    *   每条指令功能不同，涉及的操作过程不同，需要不同的控制信号。
    *   **例如:**
        *   MIPS R-型 `add` 指令: 从寄存器取数 -> 加法 -> 结果送寄存器。
        *   MIPS I-型 `ori` 指令: 从寄存器取数 -> 立即数0扩展 -> "或"运算 -> 结果送寄存器。
4.  **源操作数地址计算并取操作数 (Calculate Source Operand Address and Fetch Operand):**
    *   根据寻址方式确定。
    *   **存储器数据:** 需一次或多次访存 (如间接寻址，或两个操作数都在存储器的双目运算)。
    *   **寄存器数据:** 直接从寄存器取数。
5.  **数据操作 (Data Operation):**
    *   在 ALU (算术逻辑单元) 或加法器等运算部件中进行运算。
6.  **目的操作数地址计算并存结果 (Calculate Destination Operand Address and Store Result):**
    *   根据寻址方式确定。
    *   **存储器数据:** 需一次或多次访存 (如间接寻址)。
    *   **寄存器数据:** 直接存结果到寄存器。
*   **注意:** 串操作或向量运算指令，可能会循环执行第 (4)~(6) 步多次。
**指令功能的四种基本操作实现:**
上述指令执行过程中的功能总可由以下4种基本操作实现：
1.  读取某个存储单元的内容，并将其装入某个寄存器。
2.  把一个数据从某个寄存器存入给定的存储单元中。
3.  把一个数据从某个寄存器送到另一个寄存器或者 ALU。
4.  进行某种算术运算或逻辑运算，将结果送入某个寄存器。
**寄存器传送语言 (RTL - Register Transfer Language) 规定:**
*   `R[r]`: 表示寄存器堆中寄存器 r 的内容。
*   `M[addr]`: 表示读取存储单元 addr 的内容。
*   `←`: 表示传送方向 (源在右，目的在左)。
*   `PC`: 直接表示程序计数器 PC 的内容。
*   **示例:**
    *   `M[R[r]]`: 寄存器间接寻址 (读取寄存器 r 的内容所指的存储单元的内容)。
    *   `M[PC]`: PC 所指内存单元的内容。
---
### 6.1.2 CPU 的基本功能
CPU 的基本职能是周而复始地执行指令，但也需处理异常情况和外部中断。
*   **异常情况示例:** 非法操作码、缺页。
*   **中断请求示例:** 外部设备请求 CPU 执行。
**CPU 的具体职能:**
1.  **控制指令执行顺序:**
    *   严格按照事先安排的顺序执行。
    *   CPU 必须提供指令地址的保存场所 (PC) 和计算部件，能正确确定下条指令地址。
2.  **控制指令执行操作:**
    *   每条指令通过一系列操作实现。
    *   CPU 必须能确定操作序列，并通过指令译码生成控制信号，控制操作正确进行。

3.  **控制操作时序:**
    *   每条指令的执行有严格定时控制，各步骤间有时间顺序。
    *   CPU 必须提供对指令操作的定时控制。

4.  **对数据进行运算:**
    *   CPU 中必须提供实现所有指令功能的运算部件。

5.  **对存储器或 I/O 访问进行控制:**
    *   指令执行中需取指令、存取内存数据或访问 I/O 设备。
    *   CPU 应能提供控制，相关部件包括总线接口部件 (BIU)、存储管理部件 (MMU) 等。

6.  **异常和中断处理:**
    *   CPU 必须能够发现和处理“异常”情况及外部“中断”请求。

---

### 6.1.3 CPU 的基本组成

CPU 可看成由 **数据通路 (Data Path)** 和 **控制部件 (Control Unit)** 两大部分组成。

*   **数据通路 (Data Path):**
    *   指令执行过程中数据所经过的路径，包括路径上的部件。
    *   部件示例: ALU、通用寄存器、状态寄存器、cache、MMU、浮点运算逻辑、异常和中断处理逻辑等。
    *   **执行部件 (Execution Unit) / 功能部件 (Function Unit):** 数据通路中专门进行数据运算的部件。

*   **控制部件 (Control Unit):**
    *   根据每条指令功能的不同生成对数据通路的控制信号，并正确控制指令的执行流程。

**CPU 的基本组成原理图 (如图 6.2 所示，教学用简化模型):**
	![[image-226.png]]
包含执行部件 (ALU、通用寄存器、状态寄存器) 和控制逻辑 (或与其密切相关的逻辑)。

1.  **程序计数器 (PC - Program Counter) / 指令指针 (IP - Instruction Pointer):**
    *   存放指令地址。
    *   地址形成:
        *   **顺序执行:** PC + "1" (这里的 "1" 指一条指令的长度)。可由 PC 自身计数功能或借用运算部件完成。
        *   **改变顺序 (转移类指令):** 转移地址送到 PC。
    *   程序开始执行前，第一条指令地址送入 PC。

2.  **指令寄存器 (IR - Instruction Register):**
    *   存放现行指令。指令从存储器取出后存入 IR，以便送指令译码器译码。

3.  **指令译码器 (Instruction Decoder):**
    *   对 IR 中的操作码部分进行分析解释，产生译码信号给操作控制信号形成部件。

4.  **脉冲源及启停控制线路:**
    *   **脉冲源:** 产生一定频率的脉冲信号作为机器的时钟脉冲 (CPU 时序的基准信号)。
    *   **启停线路:** 控制时钟脉冲的开放/封锁，控制时序信号的发生/停止，实现机器启停。

5.  **时序信号产生部件:**
    *   以时钟脉冲为基础，产生不同指令对应的周期、节拍、工作脉冲等时序信号，实现指令执行过程的时序控制。

6.  **操作控制信号形成部件:**
    *   综合时序信号、指令译码信号和执行部件反馈的状态标志等，形成不同指令所需的操作控制信号序列。

7.  **总线控制逻辑:**
    *   实现对总线传输的控制，包括数据、地址信息的缓冲与三态控制。

8.  **中断机构:**
    *   实现对异常情况和某些外部中断请求的处理。

---

### 6.1.4 数据通路的基本结构

指令执行用到的元件分为两类：**组合逻辑元件 (操作元件)** 和 **存储元件 (状态元件)**。连接方式有 **总线方式** 和 **分散连接方式**。数据通路是由操作元件和存储元件通过总线或分散方式连接而成的进行数据存储、处理和传送的路径。

**1. 组合逻辑 (操作) 元件 (Combinational Logic Elements)**
*   **特点:** 输出只取决于当前输入。
*   定时不受时钟信号控制，输入信号到达后，经逻辑门延迟，输出改变并保持。
*   **常用元件 (如图 6.3):**
	* ![[image-227.png]]
    *   **多路选择器 (MUX):** 需要控制信号 `Select` 确定哪个输入被输出。
    *   **加法器 (Adder):** 操作确定，通常不需外部操作控制信号。
    *   **算术逻辑部件 (ALU):** 需要操作控制信号 `OP` 确定执行何种操作。
    *   **译码器 (Decoder):** (图中用于指令译码) 对指令操作码译码，输出译码信号 `out0, out1, ...`。

**2. 状态 (存储) 元件 (State (Storage) Elements)**
*   **特点:** 具有存储功能，输入状态在时钟控制下被写入，并保持输出值不变直到下个时钟。输入由时钟决定何时写入，输出可随时读出。
*   **D 触发器 (D Flip-Flop) (如图 6.4):**
	* ![[image-228.png]]
    *   采用时钟下降沿触发。
    *   **时间约束:**
        *   **建立时间 (Setup Time):** 时钟下降沿到来前，输入 D 必须稳定。
        *   **保持时间 (Hold Time):** 时钟下降沿到来后，输入 D 必须继续保持稳定。
    *   满足约束条件下，经过时钟下降沿后的延迟时间 (**"Clock-to-Q" time**)，输出 Q 变为输入 D 的状态，并保持到下个时钟。
*   **寄存器 (Register):** 由 n 个 D 触发器构成一个 n 位寄存器。
    *   **类型示例:**
        *   **带“写使能”的寄存器 (锁存器 - Latch / 暂存器):** 用于指令寄存器 IR、通用寄存器组 (General Register Set / 寄存器堆 Register Files)。
        *   **输出端带三态门的寄存器:** 用于与总线相连，通过三态门控制是否输出到总线。
        *   **带复位 (清0) 功能的寄存器。**
        *   **带计数 (自增) 功能的寄存器。**
        *   **带移位功能的寄存器。**
    *   这些寄存器都在时钟和相应控制信号 (写使能、三态门开、清0、自增、移位) 控制下完成信息存储。
*   **寄存器和寄存器组的外部结构 (如图 6.5):**
	* ![[image-229.png]]
    *   **(a) 暂存寄存器 (Latch):**
        *   写使能 (WE) 信号：
            *   WE=0: 时钟边沿到来，输出不变。
            *   WE=1: 时钟边沿到来，经 Clk-to-Q 延迟，输出变为输入值。
        *   若寄存器每时钟都写入，可不要 WE。
    *   **(b) 通用寄存器组 (General Register Set):**
        *   两个读口: `busA` 和 `busB` 分别由 `RA` 和 `RB` 地址选定。读操作为组合逻辑，无须时钟控制，地址有效后经“取数时间”延迟，数据在 `busA`、`busB` 上有效。
        *   一个写口: `busW` 上的信息写入地址由 `RW` 指定。写操作为时序逻辑，需时钟控制。WE=1 时，时钟边沿到来后经 Clk-to-Q 延迟，`busW` 值写入 `RW` 指定的寄存器。

**3. 数据通路与时序控制 (Data Path and Timing Control)**
*   CPU 必须按正确的时序产生操作控制信号。
    *   **(1) 早期计算机的三级时序系统 (如图 6.6):**
	    * ![[image-230.png]]
        *   **指令周期:** 分为取指令、读操作数、执行并写结果等 **机器周期**。
        *   **机器周期:** 如取指令、存储器读、存储器写、中断响应等类型。长度可能不同 (如访存周期比 CPU 操作长)。宽度通常以主存工作周期为基础。
        *   **节拍 (T-state):** 机器周期内进行若干步动作，每步在一个节拍内完成 (如存储器读：送地址、发读命令、检测数据准备好、取数据)。
        *   **工作脉冲 (Pulse):** 节拍内可设多个工作脉冲 (如寄存器内容送另一寄存器：需打开数据通路脉冲和接收脉冲)。
    *   **(2) 现代计算机的时钟信号:**
        *   不再采用三级时序，机器周期概念渐失。
        *   整个数据通路的定时信号就是 **时钟**，一个时钟周期就是一个节拍。
*   **数据通路和时钟周期 (如图 6.7):**
	* ![[image-231.png]]
    *   数据通路可看作由组合逻辑(操作)元件和状态(存储)单元交替组成。
    *   结构为: "...—状态单元—操作元件(组合电路)—状态单元—..."
    *   只有状态元件能存信息，操作元件从状态单元接收输入，输出写入状态单元。
    *   所有状态单元在同一时钟控制下写入 (如下降沿触发)。
    *   **一个时钟周期内处理过程:**
        1.  经 Clk-to-Q 时间 (Latch Prop)，前周期信号写入状态单元并输出。
        2.  送随后的操作元件处理。
        3.  经若干级门延迟，结果送到下一级状态单元的输入端。
        4.  必须稳定一段时间 (Setup Time) 才能开始下个时钟周期。
        5.  时钟信号到达后还要保持一段时间 (Hold Time)。
    *   **时钟周期 (Cycle Time):** `Cycle Time = Latch Prop + Longest Delay (最长操作延迟) + Setup Time + Clock Skew (时钟偏移)`
    *   **正常工作约束:** `Latch Prop + Shortest Delay (最短操作延迟) > Hold Time`

**4. 早期累加器型指令系统数据通路 (IAS 计算机) (如图 6.8)**
	![[image-232.png]]
*   典型累加器型指令系统结构。
*   **存储部件:** 主存 M, 累加器 AC, 乘商寄存器 MQ, 指令寄存器 IR, 程序计数器 PC, 主存缓冲寄存器 MBR, 主存地址寄存器 MAR。IBR (指令缓冲寄存器) 可看作 IR 一部分。
*   CPU 与外部数据/地址交换通过 MBR 和 MAR。
*   **ALU 操作:** 一操作数来自 AC，另一来自主存 (通过 MBR)。结果送 AC 或 MQ。
*   **数据路径示例:**
    *   **取指令:** PC→MAR, Read M, M→MBR→IBR→IR。
    *   **取操作数、运算、送结果:** 操作数地址→MAR, Read M, M→MBR→ALU 输入端, AC→ALU 输入端, ALU 操作, ALU 结果→MBR, Write M (或 ALU 结果→AC/MQ)。
**5. 单总线数据通路 (如图 6.9)**
	![[image-233.png]]
*   ALU 及所有寄存器通过一条内部公共总线连接 (CPU 内部总线)。
*   **寄存器:** R0~R(n-1) (程序员可见通用寄存器)，Y, Z (CPU 透明临时寄存器)。
*   **控制单元部件:** IR, 指令译码器。
*   **存储器接口:** MDR (数据), MAR (地址)。假定 MAR, MDR 与存储总线间无三态门，输出一直使能。
*   **单总线 CPU 结构中基本操作的实现:**
    *   **(1) 寄存器之间传送数据:**
        *   总线共享，某一时刻只能有一个部件送信息到总线。
        *   源寄存器信息送总线 -> 经延迟 -> 目的寄存器存储。
        *   **控制信号:** Rᵢₙ (输入到 R), Rₒᵤₜ (从 R 输出)。(图 6.10 示一位触发器与总线连接控制)。
	        * ![[image-234.png]]
        *   **示例:** R0 内容送 Y: 控制信号为 R0ₒᵤₜ, Yᵢₙ。
        *   **注意:** 很多 CPU 内部，寄存器堆之间无直接通路，需经 ALU。
    *   **(2) 完成算术、逻辑运算:**
        *   Y 寄存器存一操作数，另一操作数在总线上。结果暂存 Z。
        *   **示例: R[R3] ← R[R1] + R[R2] (需 3 个时钟周期/节拍)**
	        * ![[image-235.png]]
            1.  R1ₒᵤₜ, Yᵢₙ
            2.  R2ₒᵤₜ, add (ALU 控制), Zᵢₙ (图 6.11 示此步定时: 控制信号有效 (Clk-to-Signal) -> R2 输出有效 -> 三态门打开 -> 总线传输、ALU 延迟 -> Z 输入端结果到达 -> 建立时间 -> 稳定 -> 下时钟写入 Z。R2ₒᵤₜ 和 add 信号需持续到 t₅)
            3.  Zₒᵤₜ, R3ᵢₙ
    *   **(3) 从内存读取一个字 (指令或数据):**
        *   CPU 发地址和读信号后，需等待主存完成。
        *   **"异步"方式:** 主存发回 MFC (Memory-Function-Completed) 信号。CPU 等待期间采样 MFC，有效则表明数据已读出到 MDR。
        *   **示例: R[R2] ← M[R[R1]]**
            1.  R1ₒᵤₜ, MARᵢₙ
            2.  read (读命令), WMFC (Wait MFC) (CPU 进入等待，可能多周期)
            3.  MDRₒᵤₜ, R2ᵢₙ (CPU 采样到 MFC 有效后)
        *   **"同步"方式:** 存储器在读信号发出后固定时钟周期内备好数据。不需 MFC。 (SDRAM 常用)
    *   **(4) 把一个字 (数据) 写入主存:**
        *   **示例: M[R[R2]] ← R[R1]**
            1.  R1ₒᵤₜ, MDRᵢₙ
            2.  R2ₒᵤₜ, MARᵢₙ
            3.  write (写命令), WMFC (可能多周期，同步 DRAM 则不需 WMFC)
        *   若第①②步不使用相同物理通道 (如不同总线)，可同时执行 (单总线结构不允许)。

**6. 三总线数据通路 (如图 6.12)**
	![[image-236.png]]
*   提高指令执行效率，减少时钟周期数。
*   **结构:** 通用寄存器在一个双口寄存器堆 (register file) 中，允许两寄存器内容同时输出到 A 总线和 B 总线。
*   ALU 的输入来自 A、B 总线，输出到 C 总线。
*   **示例: 三操作数指令 "op R1, R2, R3" (功能 R[R3] ← R[R1] op R[R2])**
    *   可在一个时钟周期内完成。控制信号: R1ₒᵤₜᴬ, R2ₒᵤₜᴮ, op (ALU 控制), R3ᵢₙᶜ。
*   **优点:** 不需要临时寄存器 Y 和 Z (因 ALU 输入输出通路无冲突)。更易实现指令流水执行。