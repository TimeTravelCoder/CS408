好的，这是关于 "6.4 微程序控制器设计" 的学习笔记。

## 6.4 微程序控制器设计

对于复杂指令系统，硬连线路控制器结构庞杂、实现困难、维护和修改不易。这种情况下，通常采用 **微程序方式 (Microprogrammed Control)** 设计控制器。

**基本思想：** 仿照程序设计方法，将每条机器指令的执行过程用一个 **微程序 (Microprogram)** 来表示。每个微程序由若干条 **微指令 (Microinstruction)** 组成，每条微指令相当于有限状态机中的一个状态。所有指令对应的微程序存放在一个 ROM (只读存储器) 中，这个 ROM 称为 **控制存储器 (Control Store, CS)**，简称 **控存**。

**执行过程：**
1.  当执行一条机器指令时，其对应的微程序从控存中取出。
2.  在时钟控制下，按照一定顺序执行微程序中的每条微指令。
3.  通常一个时钟周期执行一条微指令。

---

### *6.4.1 Wilkes 微程序控制器

M. V. Wilkes 于 1951 年最早提出微程序概念。
**Wilkes 设计方案 (图 6.37):**
  ![[image-272.png]]
*   **核心:** 一个二极管阵列 (Diode Matrix)。
*   **时钟驱动:** 每来一个时钟，阵列的一行被激活。
*   **信号产生:** 阵列中出现二极管的地方 (图中圆点) 产生信号。
    *   **左半部:** 产生控制信号，送往数据通路。
    *   **右半部:** 产生下一个周期将要激活的行地址 (即下一条微指令的地址)。
*   **条件转移:** 当微指令需要实现条件转移时，用条件码触发器控制产生不同的微转移地址。
*   **微程序首地址:** 每条机器指令的微程序首地址由指令寄存器 (IR) 中的操作码确定。
*   **双地址寄存器:** 为避免译码器出现不稳定状态，采用了双地址寄存器 (微地址寄存器 I 和 II)。

**微程序设计的意义：**
*   大大降低了控制器设计的复杂性。
*   提高了设计的标准化程度。
*   提供了很大的灵活性，使得设计的变更、修改以及指令系统的扩充相对容易。
*   **固件 (Firmware):** 由于微程序相对固定且通常不放在主存内，而是固化在 ROM 中，故称为固件。

**微程序控制器的主要缺点：**
*   比相同或相近指令系统的硬布线控制器慢。
*   因此，RISC 机器大都采用硬连线路控制器，而像 IA-32 (x86) 这样的 CISC 系统则采用了硬连线和微程序相结合的方式来实现控制逻辑。

---

### 6.4.2 微程序控制器的结构

**1. 基本术语**

*   **微操作 (Micro-operation):** 一条机器指令的功能通过执行一系列基本操作来完成，这些基本操作称为微操作。
*   **微命令 (Micro-command):** 每个微操作在相应控制信号的控制下执行，这些控制信号在微程序设计中称为微命令 (例如，`PCin` 或 `PCWr`)。
*   **微指令 (Microinstruction):** 一个 0/1 序列，包含若干个微命令，它完成一个基本运算或传送功能。也称控制字 (Control Word, CW)。
*   **微程序 (Microprogram):** 一个微指令序列，对应于一条机器指令的功能。

**2. 微程序控制器的基本结构 (图 6.38)**
    ![[image-273.png]]
*   **输入:** 机器指令、条件码 (状态标志)。
*   **输出:** 微命令 (控制信号)。
*   **核心部件:**
    *   **控制存储器 (CS - Control Store):** 存放所有微程序。
    *   **微程序计数器 (µPC - Microprogram Counter):** 指出下一条要执行的微指令在控存中的地址。
    *   **微指令寄存器 (µIR - Microinstruction Register):** 存放从控存取出的当前微指令。
    *   **起始和转移地址发生器 (Sequencer / Microprogram Sequencer):**
        *   当新指令装入 IR 时，根据指令的操作码生成该指令对应微程序的入口地址，送入 µPC。
        *   处理微指令中的条件转移：根据微指令中的转移控制字段、条件码以及可能的外部信号，产生新的微指令地址送入 µPC。
*   **工作流程 (循环):**
    1.  **取指微程序执行:** CPU 执行程序的过程是不断地取指令、执行指令。取指令是公共操作，可以专门用一个 **取指微程序 (Fetch Microprogram)** 来实现。
    2.  **指令功能微程序执行:** 取指微程序执行完毕后，根据当前机器指令的操作码，转去执行该指令对应的功能微程序。
*   **微程序执行面临的问题 (类似机器指令执行):**
    1.  微指令格式和微命令编码问题。
    2.  下条微指令地址确定问题。
*   **微指令格式 (通常为定长):**
    *   **微操作码部分 (µOP):** 包含若干微命令。
    *   **微地址码部分 (µAddr):** 用于确定下一条微指令的地址。

---

### 6.4.3 微命令编码和微指令格式

微指令字中微操作码部分的设计，主要由微命令的编码方式决定。

**微命令编码方式：**

**1. 直接控制法 (Direct Control / Unencoded)**
*   微操作码中的每一位对应一个微命令。
*   该位为 1，则对应微命令有效；为 0 则无效。
*   **优点:** 并行控制能力强，无需译码，控制电路简单，速度快。
*   **缺点:**
    *   对于二值微命令 (如 `PCin=1`)，只占一位。对于多值微命令 (如 ALU 操作有 16 种)，若不编码则需要 16 位。
    *   机器的微命令总数很多 (可达几百个)，导致微指令字非常长，实现困难。
    *   通常一条微指令中只有少数微命令有效 (对应位为 1)，编码空间利用率低。

**2. 字段直接编码法 (Field Direct Encoding / Encoded)**
*   **基本思想:** 将微指令的微操作码部分划分为若干 **字段 (Field)**。每个字段包含若干微命令。
*   **分组原则:**
    *   **互斥 (Mutually Exclusive) 微命令** 组合在同一字段内。互斥微命令是指在数据通路中不能同时进行的微操作对应的微命令。
    *   **相容 (Compatible) 微命令** 分在不同字段内。相容微命令是指可以同时进行的微操作对应的微命令。
*   编码时对每个字段内的微命令进行编码。
*   一条微指令中最多可同时发出的微命令数等于字段的个数。
*   **例 6.2:** (针对图 6.9 和图 6.10 的单总线数据通路)
* ![[image-275.png]]
	* 
    *   **直接控制法:** 控制信号 (微命令) 共 27 个，微操作码长 27 位 (假设 ALU 操作已编码为 4 位)。
    *   **字段直接编码法 (表 6.9):**
	    * ![[image-274.png]]
        *   **分组:** 将互斥的微命令分在同一组 (字段)。例如，某一时刻只有一个寄存器能向总线输出，所以所有 `Rout` 信号互斥。
        *   **编码:** 对每组内的微命令进行编码。例如，8 个源到总线的操作 (`R0out`...`PCout`) 加一个 "无操作" 状态，需要 4 位编码。
        *   **结果:** 通过字段编码，微操作码长度从 27 位减少到 19 位。

**3. 字段间接编码法 (Field Indirect Encoding)**
*   在字段直接编码法基础上，通过一个字段的取值来解释另一个字段的含义，从而进一步压缩微指令长度。
*   **缺点:** 译码线路复杂，时间开销大，通常极少使用。

**4. 最少编码法 (Minimum Encoding / Vertical Encoding)**
*   **基本思想:** 采用类似机器指令编码的思想，将整个微操作码部分作为一个字段，每次只产生一个微操作。
*   得到的微操作码位数最少，长度最短。
*   用这种格式的微指令编写的微程序较长，因此也称为 **垂直型微指令 (Vertical Microinstruction)**。

**5. 微指令格式**

*   **水平型微指令 (Horizontal Microinstruction):** 通常指采用直接控制法或字段直(间)接编码法编码的微指令。
    *   能最大限度地表示微操作的并行性。
    *   需要较长的代码 (几十位到上百位)。
    *   能充分利用硬件并行性，速度潜力大。
    *   微程序包含的微指令条数少。
    *   适用于要求较高速度的场合。
    *   编码空间利用率较低，编制最佳水平微程序难度较大。
*   **垂直型微指令 (Vertical Microinstruction):** 通常指采用最少编码法编码的微指令。
    *   采用短格式，一条微指令只能控制一、二个微操作。
    *   格式与普通机器指令相似，设有微操作码字段。
    *   不着重于微操作的并行性，以此换取较短的微指令长度和较高的编码空间利用率。
    *   编写微程序的方法与传统程序设计方法更为接近。
    *   面向算法描述，而水平型微指令面向处理机内部控制逻辑的描述。

**例 6.3:** (针对图 6.33 的多周期数据通路)
*   采用字段直接编码法。
*   数据通路中共有 15 种控制信号 (19 位，因 `ALUOp` 可能多位)。
*   **表 6.10:** 多周期数据通路微操作分组情况及其编码表。
    *   共 9 个字段 (组)。
    *   例如，`RegOp` (寄存器操作控制) 字段包含 7 个微操作，需要 3 位编码，但由于这些微操作本身就是独立的控制信号，不编码 (直接用 3 位) 更简单且执行时无需译码。
    *   最终微指令字 (仅微操作字段) 长度为 16 位 (比直接控制的 19 位少了 3 位)。
*   **将图 6.34 的有限状态机用微程序表示 (表 6.11):**
    *   每个状态下的 0/1 序列构成一条微指令。
    *   共 12 条微指令。

---

### 6.4.4 微指令地址的确定

当前微指令执行结束后，必须确定下一条要执行的微指令的地址。

**下条微指令的可能情况：**

1.  **取指微程序的首条微指令:** 每条机器指令执行完后，需转到取指微程序。
2.  **某机器指令对应微程序的首条微指令:** 取指微程序执行完后，需根据当前指令译码结果，转到对应微程序。
3.  **某个微程序执行过程中的一条微指令:**
    *   **顺序执行:** 执行当前微指令的下一条。
    *   **无条件转移:** 转到另一处微指令执行。
    *   **条件转移:** 根据条件码或指令操作码 (`op`/`func`) 选择不同分支的微指令执行。

**下条微地址的确定方法：**

**1. 计数器法 (增量法 - Incremental Method)**
*   **思想:** 使用专门的微程序计数器 (µPC)，下条微指令地址隐含存放在 µPC 中。
*   **顺序执行:** µPC + 1 → µPC。
*   **转移执行:**
    *   在当前微指令后添加一条“转移微指令”。
    *   或在微指令中添加专门的“转移控制字段”。
    *   “转移微指令”或“转移控制字段”中的控制信息送到微指令地址发生器，与指令操作码、条件码等组合，生成转移地址送 µPC。
*   **结构:** 见图 6.38。
*   **缺点:** 必须在不连续执行的微指令间加入“转移微指令”，增加微指令条数，影响执行速度。当转移分支很多时，微地址生成逻辑复杂 (可用 PLA 或 ROM 实现)。

**2. 断定法 (下址字段法 - Next Address Field Method)**
*   **思想:** 在微指令中直接明确指定下一条微指令的地址。
*   相当于每条微指令都是转移微指令，即使不连续执行也无额外开销。
*   **优点:** 加快指令执行速度，消除了专门的转移微指令。给微指令分配地址时无需考虑排列顺序。
*   **缺点:** 增加了微指令的长度 (下地址字段通常需要较多位数)，影响控制存储器的有效利用。
*   **结构 (图 6.39):**
	* ![[image-276.png]]
    *   使用简单的微指令地址寄存器 (µAR) 存放当前微地址。
    *   **微地址修改逻辑 (Sequencer):** 根据当前指令、状态条件、当前微指令的下地址字段和转移控制字段来确定下一条微指令的地址。

**例 6.4: 计数器法与断定法实现细节比较 (基于表 6.11 的微程序)**
![[image-277.png]]
*   微地址共 4 位。取指微程序首址 0000。
*   **分支转移实现:**
    *   状态 0001 (ID 阶段) 后根据指令类型转到不同微程序 (由 ROM1 实现)。
    *   状态 1000 (`lw/sw` 地址计算后) 根据是 `lw` 还是 `sw` 决定转到 1010 (lw 取数) 还是 1001 (sw 存数) (由 ROM2 实现)。
*   **"BrCtr" (Branch Control) 微命令:** 用于控制下条微地址的选择。
*   **图 6.40(a) 计数器法微程序控制器结构:**
	* ![[image-278.png]]
    *   µPC 具自增功能。
    *   `BrCtr` 含义:
        *   `00`: 转到取指微程序首址。
        *   `01`: 转到 ROM1 输出所指地址。
        *   `10`: 转到 ROM2 输出所指地址。
        *   `11`: 按顺序执行 (µPC+1)。
    *   微指令长度为 18 位 (16 位微操作 + 2 位 BrCtr)。
*   **图 6.40(b) 断定法微程序控制器结构:**
    *   下条微地址主要来自当前微指令的下地址字段，但某些情况需修改。
    *   例如，`lw/sw` 在 1000 处的下地址字段为 1010，若 op3=1 (sw)，则将 1010 修改为 1001。
    *   `BrCtr` 含义:
        *   `00`: 下条地址 = 微指令的下地址字段。
        *   `01`: 下条地址 = op3 修改后的微地址。
        *   `10`: 下条地址 = ROM1 输出所指地址。
    *   微指令长度为 22 位 (16 位微操作 + 4 位下地址 + 2 位 BrCtr)。

计数器法和断定法中都用 ROM 实现多分支转移。ROM1 存放各指令微程序的首地址。ROM2 只有两个单元，分别存放 1001 和 1010。