好的，这是关于“8.4 总线标准”的学习笔记：

## 8.4 总线标准

*   **专用总线 vs. 标准总线**：
    *   主板上的“处理器-主存”总线经常是**特定的专用总线**。
    *   用于连接各种 I/O 模块的 **I/O 总线**和**底板式总线**则通常可在不同的计算机中互用，因此，这类总线通常是**标准总线**，可被不同公司制造的各种计算机系统所使用。

*   **I/O 总线的意义**：
    *   允许用户方便地插入设备，甚至是新开发的外围设备。
    *   是机器上扩充和连接新外设的一种常用手段。

*   **总线标准的益处**：
    *   **为制造商提供规范**：计算机制造商和外围设备制造商只要按照规范设计，就能保证新机器与外设直接连接使用。
    *   **保证兼容性**：外设制造商按照规范实现，用户的计算机就能挂接其新设备。
    *   **促进产业发展**：不同厂商可以按照同样的标准和规范生产各种不同功能的芯片、模块和整机。
    *   **用户选择多样性**：用户可以根据功能需求去选择不同厂家生产的、基于同种总线标准的模块和设备。
    *   **可定制化**：用户甚至可以按照标准自行设计功能特殊的专用模块和设备，以组成自己所需的应用系统。
    *   **兼容性和互换性**：使芯片级、板卡级和设备级等各级别的产品都具有兼容性和互换性。
    *   **提高可维护性和可扩充性**：整个计算机系统的可维护性和可扩充性得到充分保证。

*   **总线标准的形成途径**：
    1.  **事实标准 (De Facto Standard)**：由于某些机器流行而自然形成的标准。例如 IBM PC/AT 总线。一旦某个总线标准被设备制造商大量使用，其他设备制造商也会引入并提供支持。
    2.  **行业协作标准**：为了解决共性问题而由多个制造商合作提出的标准。例如 SCSI 总线和 Ethernet。标准往往会由一个小组来制定。
    3.  **标准化组织制定**：由 ANSI 或 IEEE 等组织提出的总线标准。例如 PCI 总线标准是由 Intel 发起、后来由一个工业委员会发展起来的。

*   **标准总线规范的内容**：
    *   尽管各种标准总线在设计细节上有很多不同，各有特点，但从总体上看，无论哪种总线，其规范中都包含了**信号系统、电气特性和机械物理特性**等。
    *   **信号系统的规定**通常又包含：信号分类、数据宽度、地址空间、传输速率、总线仲裁、握手协议、总线定时和事务类型等内容。

*   **本节介绍的总线标准**：
    *   本节只对有代表性的 PCI 总线作较为详细的介绍，其他 I/O 总线仅作简单介绍。
    *   一些被淘汰的总线标准也会罗列，以便于对总线概念和标准有全面理解。

### *8.4.1 ISA 总线 (Industrial Standard Architecture)

*   也称 **AT 总线**。
*   由 IBM 公司 1984 年为推出 PC/AT 而建立的系统总线标准。
*   在原先的 PC/XT 总线的基础上扩充而来。
*   推出后得到广大计算机同行的承认，兼容该标准的微型机大量出现。
*   286、386 和 486 微机尽管工作频率各异，但大多采用了 ISA 总线。

*   **主要特点**：
    1.  **寻址能力**：支持 64K I/O 地址空间、16M 主存地址空间的寻址。
    2.  **数据访问**：可进行 8 位或 16 位数据访问。
    3.  **中断与 DMA**：支持 15 级硬中断、7 级 DMA 通道。
    4.  **多主控**：是一种简单的多主控总线。除了 CPU 外，DMA 控制器、DRAM 刷新控制器和带处理器的智能接口控制卡都可成为总线主控设备。
    5.  **事务类型**：支持 8 种总线事务类型：存储器读、存储器写、I/O 读、I/O 写、中断响应、DMA 响应、存储器刷新和总线仲裁。
    6.  **时钟**：使用独立于 CPU 的总线时钟 (8MHz)，因此 CPU 可以采用比总线时钟频率更高的时钟。
    7.  **信号线**：共有 98 根信号线 (在原 PC/XT 总线的 62 根线基础上扩充了 36 根)，与原 PC/XT 总线完全兼容。
    8.  **数据线与地址线**：具有分立的数据线和地址线。
    9.  **数据线宽度**：16 位，可进行 8 位或 16 位数据的传送。
    10. **最大数据传输率 (总线带宽)**：16MBps。
    11. **地址信号线**：提供两组地址信号线 (SA19~SA0 和 LA23~LA17)，可对 16M 的主存地址空间和 64K 的 I/O 地址空间进行访问。

### *8.4.2 EISA 总线 (Extended Industrial Standard Architecture)

*   一种在 ISA 总线基础上扩充的开放总线标准。
*   从 CPU 中分离出了总线控制权，是一种具有智能化的总线。
*   支持多总线主控和突发传输方式。
*   **时钟频率**：8.33MHz。
*   **信号线**：共有 198 根信号线 (在原 ISA 总线的 98 根线基础上扩充了 100 根线)，与原 ISA 总线完全兼容。
*   **数据线与地址线**：具有分立的数据线和地址线。
*   **数据线宽度**：32 位，具有 8 位、16 位、32 位数据传输能力。
*   **总线带宽**：33MBps。
*   **地址线宽度**：32 位，寻址能力达 2<sup>32</sup> (4G)，CPU 或 DMA 控制器等主控设备能够对 4G 范围的主存地址空间进行访问。

### *8.4.3 PCI 总线 (Peripheral Component Interconnect)

*   由 Intel 公司联合 IBM、DEC、Apple、Compaq、Motorola 等 100 多家 PC 工业界的主要厂家，于 1992 年成立了 PCI 集团，统筹、强化和推广 PCI 标准。
*   PCI 规范是公开的，受到许多微处理器和外围设备生产商的支持，因此不同厂家生产的 PCI 产品是相互兼容的。

*   **定义**：一种高带宽、独立于处理器的总线。
*   **主要用途**：用于高速外设和主机相连，如图形显示适配器、网络接口控制卡、磁盘控制器等。
*   **时钟独立性**：与 CPU 的时钟频率无关。
*   **总线频率**：采用 33MHz 或 66MHz 的总线频率。
*   **数据线宽度**：32 位，可扩充到 64 位。
*   **总线带宽**：可达 133~533MBps。
*   **特性**：
    *   支持无限突发传输。
    *   支持并发工作 (挂接在 PCI 总线上的外设能与 CPU 并发工作)。

*   **PCI 总线的角色**：作为 CPU 和外设之间的一个中间层。
    *   一个或多个 PCI 总线通过 **PCI 桥 (PCI 控制器)** 和处理器总线相连。
    *   处理器总线只连接处理器/cache、主存储器和 PCI 桥。
*   **PCI 桥的作用**：
    *   使 PCI 总线独立于处理器。
    *   提供数据缓冲功能。当处理器要访问 PCI 总线上的外设时，它可以把一批数据快速写到 PCI 桥的数据缓冲器中，在这些数据通过 PCI 总线写入设备的过程中，处理器又可以去执行其他操作。这种并发工作方式提高了系统的整体性能。

*   **系统中的 PCI 总线数量**：一个系统中可有多个 PCI 总线。
	* ![[image-357.png]]
    *   **图 8.9(a)**：典型的单处理器系统中的 PCI 总线配置。
    *   **图 8.9(b)**：典型的多处理器系统中使用 PCI 总线的配置。

*   **PCI 总线的主要内容**：
    *   **(1) 信号线**：
        *   可配置为 32 位或 64 位总线。
        *   **表 8.2 必需的 50 根信号线** (按功能分组)：
            *   **系统信号**：包括时钟 (CLK) 和复位线 (RST)。
                *   CLK：时钟信号，在其上升沿每个设备对相应的输入信号进行采样。
                *   RST：复位信号，使总线上的 PCI 专用寄存器、定序器和信号转为初始状态。
            *   **地址和数据信号**：
                *   A/D[31::0] (t/s, 32根)：复用的地址和数据线。地址阶段表示地址；数据阶段表示数据。
                *   C/BE[3::0] (t/s, 4根)：复用的总线命令线和字节允许线。地址阶段表示总线命令；数据阶段表示数据线上 4 个字节中对应的那个字节是否有效。
                *   PAR (t/s, 1根)：32 根 A/D 线和 4 根 C/BE 线的偶校验信号线。地址阶段和写数据阶段由主设备驱动 PAR 信号线；在读数据阶段则由目标设备驱动 PAR 信号线。
            *   **接口控制信号**：对总线事务进行定时控制，用于在事务的发起者和响应者之间进行协调。
                *   FRAME# (s/t/s, 1根)：由主设备驱动，表示总线传输已开始并在持续进行中。在总线传输的开始 (地址阶段之初) 使该信号有效，而在进行总线传输的最后一个数据交换之前撤销该信号。 (s/t/s 表示 sustained tri-state, 由一个设备驱动并保持)
                *   IRDY# (s/t/s, 1根)：发送端就绪信号，由主设备驱动。读操作中表示主设备准备好接受数据；写操作中表示主设备已把有效数据放到 A/D 线上。
                *   TRDY# (s/t/s, 1根)：接收端就绪信号，由从设备驱动。写操作中表示从设备准备好接受数据；读操作中表示从设备已把有效数据放到 A/D 线上。
                *   STOP# (s/t/s, 1根)：由从设备驱动，表示希望主设备停止当前的总线传输操作。
                *   LOCK# (s/t/s, 1根)：表示正在进行的总线操作不可被打断，即锁定总线。
                *   IDSEL (in, 1根)：设备选择初始化信号，在配置读和配置写事务中用作片选信号。
                *   DELSEL# (in, 1根)：设备选择信号，如果某个目标识别出地址线上给定的是自己的地址的话，那么该设备就使这根线有效。主控设备接受到该信号后就知道已有设备被选中。 (in 表示输入信号)
            *   **仲裁线**：这些信号不同于其他信号，不是所有设备共享同一根信号线，而是每个总线主控设备都有一对仲裁线——总线请求和总线允许。PCI 采用集中式裁决，所有设备的仲裁线都连接到一个总线裁决器中。
                *   REQ# (t/s, 1根)：总线请求线，由需要申请总线使用权的主控设备发出。这是一根与设备有关的点对点信号线。 (t/s 表示 tri-state, 可由多个设备驱动)
                *   GNT# (t/s, 1根)：总线允许线，接受到该信号的设备将获得总线使用权。这也是一根与设备有关的点对点信号线。
            *   **错误报告信号**：用于报告奇偶校验错以及其他错误。
                *   PERR# (s/t/s, 1根)：表示一个目标在写数据阶段或一个主控设备在读数据阶段检测到一个奇偶校验错。
                *   SERR# (o/d, 1根)：可由任何一个设备发出。用以报告地址校验错或除校验错以外的其他严重错误。 (o/d 表示 open drain)
        *   **可选的 50 根信号线** (按功能分组)：
            *   **中断信号**：同裁决信号一样也是非共享信号。每个 PCI 设备有自己的中断请求线，被连到中断控制器。
            *   **Cache 支持信号**：用来对 PCI 总线上的存储器提供 cache 支持。如果系统允许 PCI 总线上的存储器支持 cache，那么当访问 PCI 总线上的某个存储单元时，必须提供相应的 cache 支持信号，用于传递 cache 侦听的结果。
            *   **64 位总线扩展信号**：包含 32 根分时复用的地址/数据线、4 根分时复用的总线命令/字节允许线以及对这 36 根信号线进行奇偶校验的一根校验信号线。它们与基本的 32 位地址和数据信号组合形成 64 位地址和数据信号。另外，还有一对要求进行 64 位传输的请求和回答信号线。
            *   **JTAG/边界扫描信号**：用于支持 IEEE 标准 194.1 (应为 IEEE 1149.1) 中定义的测试程序。

    *   **(2) PCI 命令 (事务类型)**：
        *   总线活动以发生在总线主控设备和从设备之间的**总线事务**形式进行。
        *   总线主控设备是事务的发起者，从设备是事务的响应者 (目标)。
        *   当总线主控设备获得总线使用权后，在总线事务的**地址周期**，通过分时复用的总线命令/字节允许信号线 C/BE 发出总线命令，以指出事务类型。
        *   **PCI 支持的总线命令 (事务类型) 有以下几类**：
            *   **中断响应**：一条读取中断向量的命令。用于对 PCI 总线上的中断控制器提出的中断请求进行响应。在该事务的地址周期地址线不起作用。而在数据周期，则从中断控制器读取一个中断向量，此时 C/BE 信号线用于表示读取的中断向量的长度。
            *   **特殊周期**：用于一个总线主控设备向一个或多个目标广播一条消息。
            *   **I/O 读和 I/O 写**：用于在事务发起者和一个 I/O 控制器之间进行数据传送。
            *   **存储器读、存储器行读、存储器多行读**：用于总线主控设备从存储器中读取数据。PCI 支持突发传送，所以它将占用一个或多个数据周期。这些命令的解释依赖于总线上的存储控制器是否支持 PCI 的高速缓存协议。如果支持，则与存储器之间的数据传送以 cache 行的方式进行。**表 8.3 PCI 总线上存储器读命令的含义**：![[image-358.png]]
            *   **存储器写、存储器写并无效**：这两种存储器写命令用于总线主控设备向存储器写数据，它们将占用一个或多个数据周期。其中存储器写并无效命令用于回写一个 cache 行到存储器，因此，它必须保证至少有一个 cache 行被写回。
            *   **配置读、配置写**：用于一个总线主控设备对连接到 PCI 总线上的设备中的配置参数进行读或更新。每个 PCI 设备都有一个寄存器组 (最多可有 256 个寄存器)，这个寄存器用于系统初始化时对本设备进行配置。
            *   **双地址周期**：由一个事务发起者用来表明它将使用 64 位地址来寻址。

    *   **(3) 数据传送过程** (图 8.10 PCI 读操作时序)：
        *   PCI 总线事务中，所有事件在**时钟下降沿** (即时钟周期的中间) 同步。
        *   总线设备在一个时钟周期开始的**上升沿**采样总线信号。
        *   **重要事件说明 (参考图 8.10)**：
            1.  **①** 总线主设备一旦获取总线使用权，就通过使 FRAME# 信号有效来开始一个事务，同时事务发起者还将起始地址送到 A/D 线上，将“读”命令送到 C/BE 线上。FRAME# 信号一直有效，直到它准备传送最后一个数据。
            2.  **②** 在第二个时钟的开始处，目标设备识别出 A/D 线上的地址。
            3.  **③** 事务发起者停止驱动 A/D 线上的信号。(用两个环形箭头表示的换向周期，确保 A/D 信号线下次为目标设备所用)。同时，事务发起者将改变 C/BE 线上的信号，以指示 A/D 线上传送的有效数据是哪些字节。此外事务发起者还使 IRDY# 信号有效，表明它已准备好接收第一个数据。
            4.  **④** 被选中的目标设备使 DEVSEL# 信号有效，以表明它已经识别出地址，并即将响应事务。它将请求的数据放到 A/D 线上，然后使 TRDY# 信号有效，表明 A/D 上的数据已经有效，可以读取。
            5.  **⑤** 在第 4 个时钟开始处，事务发起者读取数据，并改变 C/BE 线上的字节允许信号，为下一次读做准备。
            6.  **⑥** (图示例子中) 假定目标设备需要一些时间来准备第二个数据，所以它将 TRDY# 信号撤销，以通知事务发起者下一周期没有新数据。这样，事务发起者在第 5 个周期开始时就不会读数据，并且在这个周期中不改变 C/BE 线上的字节允许信号。第二个数据在第 6 个时钟开始时被读取。
            7.  **⑦** 在第 6 周期中间，目标设备将第 3 个数据放到总线上。(图示例子中) 假定事务发起者没有准备好接收数据 (例如，用来存放数据的缓冲已满无法接受新数据)，所以，它将取消 IRDY# 信号，这样就会使目标设备将第 3 个数据继续在 A/D 线上多保持一个时钟周期。
            8.  **⑧** 事务发起者知道第 3 个数据是最后一个，所以它就将 FRAME# 信号撤销，以通知目标设备这是最后一次数据传送。同时，它将 IRDY# 信号有效，表示它已准备好接收数据。
            9.  **⑨** 事务发起者接受完数据，撤销 IRDY# 信号，使总线变为空闲。同时目标设备也相应地撤销 TRDY# 和 DEVSEL# 信号。

    *   **(4) 总线裁决** (图 8.11 PCI 总线裁决过程)：
    * ![[image-359.png]]
        *   PCI 采用**独立请求集中裁决**方式。
        *   每个总线主设备都有两个独立的请求线 REQ# 和允许线 GNT#。
        *   PCI 总线规范没有规定具体的仲裁算法。总线仲裁器可以使用静态的固定优先级法、循环优先级法或先来先服务法等仲裁算法。
        *   PCI 必须为它的每个总线事务进行仲裁，而且可以在总线进行数据传送的时候进行仲裁，因此仲裁不会浪费总线周期。这种方式称为**隐式仲裁 (Hidden Arbitration)**。
        *   **图 8.11 中设备 A 和设备 B 的总线仲裁过程说明**：
            1.  **①** 在第 1 个时钟开始前，设备 A 已经使它的 REQ# 信号有效，总线裁决器在第一个时钟开始时检测到这一信号。
            2.  **②** 在第 1 个时钟周期中，设备 B 使它的 REQ# 信号有效，也请求使用总线。
            3.  **③** 同时，总线裁决器向设备 A 发出 GNT# 信号，授权设备 A 可以访问总线。
            4.  **④** 设备 A 在第二个时钟开始检测到 GNT# 信号，知道自己已被允许使用总线。同时，它发现 IRDY# 和 TRDY# 信号都没有声明 (表明总线空闲)。因此，它将 FRAME# 信号有效，表明它要使用总线，同时将地址和命令信息放到相应的信号线上。因为设备 A 希望继续进行第二次交换，所以继续让 REQ# 有效。
            5.  **⑤** 总线裁决器在第 3 个时钟开始采样所有 REQ# 线，根据裁决算法决定由设备 B 进行下一次总线事务。这时，它向设备 B 发回 GNT# 信号，而撤销设备 A 的 GNT# 信号。但设备 B 只有等到总线空闲后才能使用总线。
            6.  **⑥** 设备 A 撤销 FRAME# 信号，表示正在进行最后一次数据传送。它将数据放到数据总线上，并用 IRDY# 通知目标设备，目标设备在下一个周期读取数据。
            7.  **⑦** 在第 5 个时钟开始，设备 B 发现 IRDY# 和 TRDY# 信号都没有声明，表明总线是空闲的。因此，它将 FRAME# 信号有效表明它要使用总线，它同时将地址和命令信息放到相应的信号线上。因为它不希望继续进行第二次交换事务，所以它撤销了 REQ# 信号。
            *   在设备 B 完成它的事务后，设备 A 将获得总线使用权，以进行它的第二次数据交换事务。
        *   **结论**：PCI 的总线仲裁确实和数据传送同时进行，因此，PCI 的事务过程中只有一个地址周期和若干个数据周期组成，不包含裁决周期。

*   **PCI 总线的发展**：
    *   从第一个版本 PCI 1.0 (33MHz/32b) 公布以来，已经发展出了多个版本：PCI 66MHz/32b、PCI 33MHz/64b、PCI 66MHz/64b。
    *   1999 年又出现了更高带宽的 PCI-X 总线，并且有多个 PCI-X 版本。