好的，这是关于 9.5 I/O数据传送控制方式 的学习笔记：

---

**9.5 I/O数据传送控制方式**

I/O数据传送控制方式分为以下4种：

**9.5.1 程序直接控制I/O方式**

程序直接控制方式直接通过查询程序来控制主机和外设之间的数据交换，通常有以下两种类型：

1.  **无条件传送方式 (同步传送方式)**
    *   主要用于对一些简单外设（如开关、继电器、7段显示器或机械式传感器等）在规定的时间用相应的I/O指令对接口中的寄存器进行信息的输入或输出。
    *   实质是通过程序来定时，以同步传送数据，适合于各类巡回检测采样或过程控制。
    *   **接口示意图 (图9.33)：** 接口中有一个数据锁存器和一个三态缓冲器，它们共用同一个地址，可以看成是同一个输入输出数据寄存器。通过相应的I/O指令可直接对该寄存器进行访问，在读写信号的控制下进行数据的输入和输出。
	    * ![[image-333.png]]
    *   **特点：** 接口比较简单，无须任何定时信号和状态查询，只需要进行相应的读写控制和地址译码即可。Intel 8255A中的方式0即是典型的无条件传送接口。
    *   **处理器操作：** 处理器对外设接口进行周期性的定时访问，直接对I/O端口进行数据存取。
    *   **开销与适用性：**
        *   处理器在I/O操作上的时间开销多少与定时访问的时间间隔有关。
        *   **慢速设备：** 定时访问时间间隔长，I/O操作所用的处理器时间占整个处理器时间的比例较少，对处理器效率影响不大。
        *   **快速设备：** 需要频繁地进行I/O访问，很多处理器时间被I/O操作占用，不宜用于高速设备的I/O。

2.  **条件传送方式 (异步传送方式 / 程序查询方式)**
    *   对于一些较复杂的I/O接口，往往有多个控制、状态和数据寄存器，对设备的控制必须在一定的状态条件下才能进行。
    *   此时，可通过在查询程序中安排相应的I/O指令，由这些指令直接从I/O接口中取得外设和接口的状态，如“就绪(Ready)”、“忙(Busy)”、“完成(Done)”等，根据这些状态来控制外设和主机的信息交换。
    *   这是一种通过查询接口中的状态来控制数据传送的方式，所以也被称为程序查询方式。
    *   **接口结构 (图9.34)：**
	    * ![[image-334.png]]
        *   **左边 (系统总线侧)：** CPU通过执行I/O指令来访问I/O接口。通过系统总线向I/O接口送出“启动”命令，读取“就绪”等状态信息，并向(从)数据缓冲寄存器写入(读取)数据。
        *   **右边 (设备侧)：** 和设备相连的电缆或接口插座侧，可以送出“启动设备”命令，或接受“设备工作结束”信号，并可通过数据线与设备交换数据信息。
    *   **CPU采用条件传送方式通过该I/O接口读取外设数据的过程：**
        1.  CPU执行相应的I/O指令向该接口送出“启动”命令，设备选择电路对CPU送出的地址进行译码，选中本I/O接口，这样，与非门输出信号使“完成”状态触发器D清0，而使“启动”命令触发器B置1。
        2.  I/O接口通过连接电缆向外设发送“启动设备”命令。
        3.  外设准备好一个数据，通过电缆向I/O接口中的数据缓冲寄存器输入数据。
        4.  外设向I/O接口回送“设备工作结束”状态信号，使状态触发器D置1，使命令触发器B清0。
        5.  CPU通过执行指令不断读取I/O接口状态，因触发器D已被置1，故CPU查询到外设“准备就绪”。
        6.  CPU通过执行I/O指令从数据缓冲寄存器读取数据。
        *   通过以上6个步骤，CPU和外设之间完成一次数据交换过程。
    *   **适用性判断：** 设备是否适合采用条件传送方式，主要取决于I/O设备本身的特点以及设备是否能够独立启动I/O等。
        *   **随机启动的低速I/O设备 (键盘、鼠标等)：** 虽然可以采用定时程序查询方式，但由于设备的启动是由用户随机进行的，所以有可能用户长时间没有输入而引起查询程序长时间等待，从而降低处理器的使用效率。这类设备大多采用中断方式进行I/O。
        *   **由操作系统启动的成块传送设备 (磁盘、磁带、光盘存储器等)：** 一旦被启动，便可连续不断地传送一批数据，处理器无须对每个数据的传送进行启动，而且每个数据之间的传输时间很短。如果用定时查询方式，则会因为频繁查询而使处理器为I/O操作所花费的时间比例变得很大，不适合采用程序查询方式。
        *   **字符类设备 (针式打印机等)：** 每个字符之间的传输时间较长，并且每传送一个字符需要启动一次，因而可以采用程序查询方式。
    *   **程序查询方式的类型：**
        *   **定时查询：** 周期性地查询接口状态，一旦进入查询，则总是一直等到条件满足，才进行一个数据的传送，传送完成后返回到用户程序。定时查询的时间间隔与设备的数据传输率有关。
        *   **独占查询：** 一旦操作系统发出一个对设备的启动命令，它就必须接连不断地查询。这种一旦设备被启动，CPU就一直持续对设备进行查询的方式，称为独占查询方式。CPU被独占用于某设备的I/O，它完全控制I/O整个过程，也即CPU花费100%的时间在I/O操作上，此时外设和CPU完全串行工作。其查询程序的流程如图9.35所示。
            *   在任何一个数据传送之前，必须先读接口的状态，判断接口是否“就绪”，只有在接口“就绪”的情况下，才继续进行传送。否则，CPU将一直处于等待状态直到外设完成任务而使接口满足条件为止。
            *   “就绪”的含义：对于输入设备而言，意味着设备已将数据送入接口中的数据缓冲器，CPU可以从接口取数据；对于输出设备而言，意味着数据缓冲器已空，CPU可以将新的数据送到接口中。
    *   **程序查询I/O方式的特点：** 简单、易控制、外围接口控制逻辑少。
    *   **缺点：** CPU需要从外设接口读取状态并在条件不满足时继续等待外设完成任务，由于外设的速度比处理器慢得多，所以，在CPU等待外设完成任务的过程中浪费了许多处理器时间。

**9.5.2 程序中断I/O方式**

在计算机发展进程中，处理器速度提高很快，而外设速度改善较慢，两者之间速度相差很大。在独占程序查询方式中，CPU和外设采用完全串行的工作方式，使处理器大量宝贵时间花在等待极慢速的外设上。为避免CPU长时间等待外设，提出了“中断”控制I/O方式。

1.  **中断的概念**
    *   “中断”是指外部设备向CPU发出的外部中断。
    *   **基本思想：** 当CPU需要进行一个I/O操作时，先启动外设工作，并挂起执行I/O操作的进程，然后从就绪队列中选择另一个进程执行，此时，外设和CPU并行工作。当外设完成操作，便向CPU发中断请求。CPU响应请求后，就中止现行程序的执行，转入一个“中断服务程序”，在“中断服务程序”中完成数据传送任务，并启动外设进行下一个操作。“中断服务程序”执行完后，返回原被中止的程序断点处继续执行。此时，外设和CPU又开始并行工作。
    *   上述过程可由图9.36和图9.37来说明。
	    * ![[image-335.png]]
    *   **优点：** 除了可以实现外设和CPU并行工作外，还能处理一些外设的异常事件和特殊事件，如打印机缺纸、磁盘寻道结束、DMA传送结束等。
    *   **中断处理系统：** 现代计算机系统中都配有完善的异常和中断处理系统。CPU的数据通路中有相应的异常和中断的检测和响应逻辑，在外设接口中有相应的中断请求和控制逻辑，操作系统中有相应的中断服务程序。这些异常和中断处理硬件线路和中断服务程序有机结合，共同完成异常和中断的处理过程。
    *   **与内部异常的区别：**
        *   “缺页”或“溢出”等异常事件是由特定指令在执行过程中产生的，而中断相对于指令的执行则是异步的。也就是说，中断不和任何指令相关联，也不阻止任何指令的完成。因此，CPU只需要在开始一个新指令之前检测是否有外部发来的中断请求即可。
        *   异常的发生和异常事件的类型是由CPU自身发现和识别的，不必通过外部的某个信号通知CPU。而对于中断，CPU必须通过对外部中断请求线进行采样，并从总线上获取相应的中断源设备的标识信息，才能获知哪个设备发生了何种中断。

2.  **中断系统的基本职能和结构**
    *   现代计算机的中断处理功能相当丰富，没有配置中断系统的计算机是令人无法想象的。
    *   **基本功能：**
        *   **及时记录各种中断请求信号：** 对于外部中断，中断系统中必须要有能够及时记录各种外部中断请求信号的部件，一般是用一个中断请求寄存器来保存。
        *   **自动响应中断请求：** 中断事件是在外部设备需要CPU干预时产生的，所以CPU必须能够在发生中断事件后，自动响应并处理。中断响应是在CPU执行指令的流程中固定安排的，总是在一条指令执行完、取出下条指令前去检查有无中断请求发生。若有，则根据情况决定是否响应和响应哪个中断请求。
        *   **自动判优：** 在计算机系统中，中断源有很多，中断被响应前，可能会有多个中断源提出中断请求。因此，中断系统中必须要有相应的中断判优逻辑，在有多个中断请求同时产生时，能够判断出哪个中断的优先级高，选择优先级高的中断先被响应。
        *   **保护被中断程序的断点和现场：** 因为中断响应后要转去执行中断服务程序，而执行完中断服务程序后，还要回到原来的程序继续运行。所以原程序被中止处的指令地址和原程序的程序状态和各寄存器的内容等必须被保存，以便能正确回到原被中止处继续执行。
        *   **中断屏蔽：** 现代计算机大多采用中断嵌套技术。也就是说，中断系统允许CPU在执行某个中断服务程序时，被新的中断请求打断。但是并不是所有的中断处理都可被新的中断打断，对于一些重要的紧急事件的处理，就要设置成不可被其他新的中断事件打断，这就是中断屏蔽的概念。中断系统中要有中断屏蔽机制，使得每个中断可以设置它允许被哪些中断打断，不允许被哪些中断打断。这个功能主要通过在中断系统中设置中断屏蔽字来实现。屏蔽字中的每一位对应某一个外设或中断源，称为该外设的中断屏蔽位。
    *   **中断系统的基本结构 (图9.38)：**
	    * ![[image-336.png]]
        *   来自各个设备的外部中断请求记录在中断请求寄存器中的对应位。
        *   每个中断源有各自对应的中断屏蔽字，在进行相应的中断处理之前它被送到中断屏蔽寄存器中。
        *   CPU运行程序时，每当CPU完成当前指令的执行、取出下一条指令之前，就会通过采样中断请求信号线来自动查看有无中断请求信号。若有，则会发出一个相应的中断回答信号，启动图9.38中的“中断查询”线。
        *   在该信号线的作用下，所有未被屏蔽的中断请求信号一起送到一个判优线路中，判优线路根据中断响应优先级选择一个优先级最高的中断源。
        *   然后用一个编码器对该中断源进行编码，得到对应的中断源设备类型号（即中断源的标识信息，称为中断类型）。
        *   CPU取得中断源的标识信息后，经过一系列相应的转换，就可得到对应的中断服务程序的首地址，在下一个指令周期开始，CPU执行相应的中断服务程序。
    *   **中断嵌套 (图9.39)：** 在中断处理（即执行中断服务程序）过程中，若又有新的优先级更高的中断请求发生，那么CPU应立即中止正在执行的中断服务程序，转去处理新的中断。
	    * ![[image-337.png]]
        *   中断响应优先级：由查询程序或硬件判优排队线路决定的优先级，它反映的是多个中断同时请求时选择哪个先被响应。
        *   中断处理优先级：由各自的中断屏蔽字来动态设定的，反映了本中断与其他所有中断之间的处理优先关系。
        *   在多重中断系统中通常用中断屏蔽字对中断处理优先权进行动态分配。

3.  **中断过程**
    *   包括中断响应和中断处理两个阶段。中断响应阶段由硬件实现，而中断处理阶段则由CPU执行中断服务程序来完成，所以中断处理是由软件实现的。
    *   **(1) 中断响应**
        *   指主机发现中断请求，中止现行程序的执行，到调出中断服务程序这一过程。因此，中断响应过程是处理器从一个进程切换到另一个进程的过程。在此过程中处理器应完成以下三个任务：
            *   **保存好被中断程序断点处的关键性信息：** 为保证被中断程序在从中断服务程序返回后能在断点处继续正确执行下去，有两类信息不能被中断服务程序破坏：
                *   用户可见的工作寄存器的内容（现场信息）。
                *   指令不可访问的程序计数器PC和程序状态字寄存器PSWR的内容（断点信息）。
                *   现场信息：因为是用户可访问的，所以通常在中断服务程序中通过指令把它们保存到一个特定的存储区（如堆栈），即由软件实现。
                *   断点信息：因为必须将中断服务程序的首地址装入到PC中才能转到中断服务程序执行，所以，原来在PC中的断点信息应在中断响应开始时由硬件自动保存到一个特定的地方（堆栈或专门寄存器）。PSWR也由硬件保存。
            *   **识别中断源并判优：** 中断响应的结果是调出相应的中断服务程序来执行。因此，在中断响应过程中，处理器必须能够识别出哪些中断有请求，并且在有多个中断请求出现的情况下，选择响应优先级最高的中断。
            *   **调出中断服务程序：** 处理器通过相应步骤得到所选择的中断源对应的中断服务程序的首地址和初始程序状态字，并把它们分别送PC和PSWR。这样，在中断响应结束后的下一个时钟周期，处理器就转入相应的中断服务程序执行。
        *   **中断响应时间：** 处理器响应中断的时间越短越好。它反映了计算机系统的灵敏度。与断点保存的时间、中断源识别和判优的速度以及获得中断服务程序首地址和初始状态的时间都有关系。
        *   **保证断点和现场的保护过程不被新的中断请求打断：** 通常用一个“中断允许”触发器（或状态位）来实现控制。当CPU中的“中断允许”触发器为1时，CPU处于“中断允许”（或“开中断”）状态。CPU只有在“中断允许”状态时，才有可能响应新的中断请求。
        *   **中断响应的条件：**
            1.  CPU处于“开中断”状态。
            2.  至少要有一个未被屏蔽的中断请求。
            3.  当前指令刚执行完（对于非流水线处理器，此时PC中存放的是下条指令的地址）。
        *   **中断响应周期 (隐指令)：** 当处理器同时满足上述三个条件时，就响应中断，进入中断响应周期，它是一种特殊的机器执行周期。在中断响应周期中，通过执行一条隐指令，完成以下几个操作：
            1.  **关中断：** 将中断允许标志置为禁止（即“关中断”）状态。
            2.  **保护断点：** 将PC和PSW送入堆栈或特殊寄存器。
            3.  **识别中断源并转中断服务程序：** 通过某种方式，获得优先级最高的中断源所对应的中断服务程序的首地址和初始PSW，并分别送PC和PSWR。
        *   **中断源的识别和判优方法：**
            *   **软件查询方法：** CPU检测到中断请求时，通过中断响应，自动转到一个特定的中断查询程序。在中断查询程序中，按中断优先顺序依次查询哪个设备有中断请求，并转到第一个查询到有请求的中断服务程序去执行。这种软件中断识别方式的中断接口硬件结构很简单，只需要一根中断请求线和一个中断请求寄存器。而且，可通过改变软件中的查询顺序来改变中断响应优先级，因而比较灵活。但是，因为软件查询速度慢，因而中断请求可能无法得到实时响应。图9.40给出了这种软件查询方式下中断查询程序的结构和中断接口的硬件结构。
	            * ![[image-339.png]]
            *   **硬件判优方法 (向量中断方式)：** 一种不同于软件查询的中断处理技术。它通过中断接口中的判优线路和优先权编码器，得到所有未被屏蔽的中断请求中具有最高优先权的中断类型（中断源标识），从而找到对应中断服务程序的首地址PC和初始PSW。
                *   **中断向量 (IV - Interrupt Vector)：** 中断服务程序的首地址PC和初始PSW。
                *   **中断向量表 (中断入口地址表)：** 所有中断向量存放的一个表，中断向量所在的地址称为向量地址VA。
                *   **硬件判优法的两种实现：**
                    *   **链式查询 (菊花链)：** 将查询程序硬化，采用菊花链方式进行，其对应的中断请求和中断响应电路结构和过程类似于总线裁决中的链式查询。由于链式查询的优先级固定，中断响应速度慢，特别是由于无法为每个中断设置屏蔽字，所以也不支持多重中断。
                    *   **独立请求：** 现代计算机系统大多采用独立请求方式来进行中断源的识别和判优。中断接口中有一个专门的中断控制器。各个中断请求信号和对应的中断屏蔽位进行“与”操作后，送到优先级分析器中进行排队判优，最后通过编码器输出对应的中断类型号。这种方式下，中断响应速度快。如果是可编程的中断控制器，则优先级可灵活设置。Intel 8259A就是一个典型的可编程中断控制器 (图9.43)。
	                    * ![[image-340.png]]
                        *   **8259A主要功能：** 中断请求锁存、中断屏蔽、中断优先级排队、中断源标识信息的生成等；既可支持程序查询式中断，又可支持向量式中断；支持8级优先权，通过多片级联，最多可构成64级中断；各种中断功能可通过编程来设定和更改。
    *   **(2) 中断处理**
        *   中断处理的过程就是CPU执行相应的中断服务程序的过程，不同的中断源其对应的中断服务程序不同。
        *   **典型中断处理的三个阶段 (图9.44)：**
	        * ![[image-341.png]]
            *   **先行段：**
                *   **保护现场：** 保护被中断程序的工作寄存器内容。
                *   **设置新的屏蔽字：** 根据本中断的处理优先级设置中断屏蔽寄存器。
                *   **开中断：** 允许响应更高级别的中断。
            *   **本体段：** 执行具体的中断服务操作，如数据传送、错误处理等。
            *   **结束段：**
                *   **关中断：** 防止在恢复现场和返回过程中被新的中断打断。
                *   **恢复现场和旧屏蔽字。**
                *   **清除中断请求：** 清除已处理中断的请求标志。
                *   **开中断并返回：** 执行中断返回指令，返回到被中断程序的断点处。

**9.5.3 DMA方式**

DMA (Direct Memory Access) 称为直接存储器存取，该输入输出方式用专门的DMA接口硬件来控制外设与主存间的直接数据交换，数据不通过CPU。

*   **DMA控制器：** 专门用来控制总线进行DMA传送的接口硬件。
*   **DMA传送过程：** CPU让出总线控制权，由DMA控制器控制总线。
    *   **周期窃取：** 通过“窃取”一个主存周期完成和主存之间的一次数据交换。
    *   **独占总线：** 或独占若干个主存周期完成一批数据的交换。
*   **适用场景：** 主要用于磁盘等高速设备的数据传送。这类高速设备的记录方式多采用数据块组织方式，数据块之间有间隙，因而数据传输时数据块之间的时间间隔较长，而数据块内部数据间的传输时间间隔较短。因此，这类设备大多采用成批数据交换方式。
*   **与中断I/O方式的相似之处：** 也是采用“请求-响应”方式。
*   **与中断I/O方式的区别：** 中断I/O方式请求的是处理器的时间，而DMA方式下请求的是总线控制权。
*   **DMA在磁盘数据交换中的应用 (图9.47)：**
	* ![[image-342.png]]
    1.  **参数设置 (初始化)：** 采用程序查询方式设置传送参数，通过执行相应的指令对有关参数寄存器进行初始化。
    2.  **启动寻道：** CPU执行输出指令发出“寻道”命令到磁盘控制器，由磁盘控制器控制磁盘驱动器开始移动磁头，同时CPU切换到其他程序执行。
    3.  **寻道结束中断：** 当磁盘完成寻道操作后，向CPU发出“寻道结束”中断请求。
    4.  **启动查找扇区：** CPU响应并处理该中断请求，通过执行输出指令发出“查找扇区”命令到磁盘控制器。
    5.  **查找扇区结束中断：** CPU启动“查找扇区”命令后，返回原程序执行；当磁盘完成扇区查找操作，就向CPU发出“查找结束”中断请求。
    6.  **启动DMA传送：** CPU响应并处理该中断，启动进行DMA传送，由DMA控制器控制数据在主存和磁盘之间进行数据传送。
    7.  **DMA结束中断：** CPU启动DMA传送后，又回到原程序继续执行，直到DMA传送结束；此时，由DMA控制器发出“DMA结束”中断请求，CPU响应并处理该中断请求，对传送的数据进行校验等后处理。

1.  **三种DMA方式**
    *   由于DMA控制器和CPU共享主存，所以可能出现两者争用主存的现象。为使两者协调使用主存，DMA通常采用以下三种方式之一进行数据传送 (图9.48)：
	    * ![[image-343.png]]
        *   **(1) CPU停止法：** DMA传输时，由DMA控制器发一个停止信号给CPU，使CPU脱离总线，停止访问主存，直到DMA传送一块数据结束。
            *   **缺点：** CPU工作受到很大影响。即使是高速设备，两个数据之间的准备间隔时间也总大于一个主存周期，这使主存周期空闲程度比较高，主存周期未被充分利用。
            *   **优点：** 控制简单，在传输速率很高的外设中实现成组数据传送时比较适用。
        *   **(2) 周期挪用法 (周期窃取)：** DMA传输时，CPU让出一个总线事务周期，由DMA控制器挪用一个主存周期来访问主存，传送完一个数据后立即释放总线。是一种单字传送方式。
            *   **优点：** 既能及时响应I/O请求，又能较好地发挥CPU和主存的效率。由于在下一个数据准备阶段，主存周期能被CPU充分利用，因此它适合于设备读写周期大于主存周期的情况。
            *   **缺点：** 每次DMA访存都要申请总线控制权和释放总线，增加了传输开销。
            *   **周期挪用时可能遇到的三种情况：**
                1.  **CPU不需访问主存：** 如CPU正在执行乘法指令，或CPU访问cache命中。此时CPU在执行指令，总线可被DMA使用。两者并行。
                2.  **CPU正在访问主存：** 必须等到主存存储周期结束后，CPU让出总线，DMA才能访存。
                3.  **CPU也同时要访问主存：** 出现访存冲突。因为不马上响应DMA请求的话，高速设备可能会发生数据丢失，所以DMA的总线优先权比CPU高。通常，先让DMA占用总线，窃取一个主存周期，完成一个数据交换后释放总线。因此，CPU需延迟一段时间后才能访存。
        *   **(3) 交替分时访问法 (透明DMA)：** 每个存储周期分成两个时间片，一个给CPU，一个给DMA。这样在每个存储周期内，CPU和DMA都可访问存储器。
            *   适用于CPU工作周期比主存存取周期更长的情况。
            *   在这种方式下，DMA不需要总线使用权的申请和释放，CPU既不停止主程序的运行也不进入等待状态。在CPU工作过程中，不知不觉地完成了DMA数据传送，故又被称为“透明的DMA”方式。

2.  **DMA接口的结构和功能**
    *   DMA数据传送过程是由DMA接口的控制逻辑完成的，一般把DMA接口中控制传送的硬件逻辑称为DMA控制器，它能像CPU一样控制总线。
    *   **典型DMA接口结构 (图9.49)：**
	    * ![[image-344.png]]
        *   **参数寄存器：** 主存地址寄存器、数据传送字计数器、控制寄存器、设备地址寄存器等。
        *   **逻辑电路：** “DMA请求”和“总线请求”逻辑，以及总线控制逻辑。
        *   **数据缓冲存储器 (可选)：** 在发生延迟传输时或等待成为总线主控设备期间，能够灵活地处理传送。
    *   **DMA接口类型：**
        *   **分离型集中多路DMA接口：** 将各设备接口中公用的DMA控制逻辑部分分离出来，成为通用的DMA控制器，而各设备有自己的I/O接口。
        *   **合并型DMA接口：** 将DMA控制逻辑和I/O接口合并为一个DMA接口。
            *   **选择型DMA接口：** 是各I/O接口的公共部分和DMA控制逻辑合并为一个DMA接口，通过I/O总线分时控制多个设备。
            *   **单通道型DMA接口：** 一个DMA接口对应一个设备。
    *   **DMA接口主要功能：**
        1.  能接收外设发来的“DMA请求”信号，并能向CPU发“总线请求”信号。
        2.  当CPU发出“总线响应”信号后，能接管对总线的控制。
        3.  能在地址线上给出主存地址，并自动修改主存地址。
        4.  能识别传送方向以在控制线上给出正确的读写控制信号。
        5.  能自动更新传送数据个数，并判断是否为0。
        6.  能发出DMA结束信号，引起一次DMA结束中断，让CPU进行数据校验等后处理。

3.  **DMA操作步骤**
    *   **第一步：DMA控制器的预置 (初始化)**
        *   在进行数据传送之前，CPU先执行一段初始化程序，完成对DMA控制器中各参数寄存器的初始值的设定。主要操作：
            1.  **准备内存区：** 若是从外设输入数据，则进行内存缓冲区的申请，并对缓冲区进行初始化；若是输出数据到外设，则先在内存准备好数据。
            2.  **设置传送参数：** 执行输入输出指令来测试外设状态，并对DMA控制器设置各种参数，例如：
                *   内存首址 → 地址寄存器
                *   字计数值 → 字计数器
                *   传送方向 → 控制寄存器
                *   设备地址 → 设备地址寄存器
            3.  启动外设进行相应的操作，然后CPU继续执行其他程序。
    *   **第二步：DMA数据传送 (DMA传送)**
        *   CPU对DMA传送参数进行预置并启动外设工作后，就把数据传送的工作交给了DMA控制器。整个传输过程中不需要CPU参与，完全由DMA硬件实现。对照图9.49，其传送过程：
            1.  当外设准备好数据（从外设取数），或准备好接收数据（向外设送数）时，就发“选通”信号，使数据送数据缓冲寄存器，同时DMA请求触发器置“1”。
            2.  DMA请求触发器向控制/状态端口发“Ready”信号，同时向DMA控制器发“DMA请求”信号。
            3.  DMA控制器接受到“DMA请求”信号后，就向CPU发“总线请求”信号。
            4.  CPU完成现行总线操作后，响应DMA请求，向DMA控制器发出“总线响应”信号。DMA控制器接受到该信号后，向外设接口发“DMA响应”信号，使DMA请求触发器复位。此时，CPU浮动它的总线，让出总线控制权，由DMA控制器控制总线。
            5.  DMA控制器给出内存地址，并在其读写线上发出“读”命令或“写”命令，随后在数据总线上给出数据。
            6.  根据读写命令，将数据总线上的数据写入存储器中，或写入外设数据端口，并进行主存地址增量，字计数值减1。
            7.  若采用“CPU停止法”，则循环第(6)步，直到计数值为“0”；若采用“周期挪用法”，则释放总线，下次数据传送时再按过程(1)到(6)进行。
    *   **第三步：DMA结束处理 (后处理)**
        *   根据计数值为“0”，发出“DMA结束”信号送DMA接口，控制产生“DMA结束”中断请求信号给CPU，转入中断服务程序，做一些数据校验等后处理工作。

\*4. **DMA与存储系统**

当DMA方式引入到I/O系统中时，存储系统和CPU之间的关系会变得更复杂。

*   **虚拟存储器环境下的DMA：**
    *   页面数据同时有物理地址和虚拟地址，DMA是以虚拟地址还是以物理地址工作？
        *   **虚拟地址DMA：** DMA接口中必须将页面的虚拟地址转换为物理地址。
        *   **物理地址DMA (更常见)：** 每次DMA传送不能跨页。如果一个I/O请求跨页，那么一次请求的一个数据块在送到主存时，就可能不在主存的一个连续的存储区中。
            *   **解决方法1：** 限制所有的DMA传送都必须在一个页面之内进行。
            *   **解决方法2：** DMA接口中应该有一个小的类似页表的地址映射表，用于将虚拟地址转换为物理地址。在DMA初始化的时候，由操作系统进行地址映射。
            *   **解决方法3 (常用)：** 操作系统把一次传送分解成多次小数据量传送，每次只限定在一个物理页面内进行。
*   **Cache环境下的DMA (I/O一致性问题 / 过时数据问题)：**
    *   一个数据项可能会产生两个副本，一个在cache中，一个在存储器中。
    *   DMA控制器直接向存储器发出访存请求而不通过cache，这时DMA看到的存储器单元的值与CPU看到的cache中的副本可能不同。
    *   **从磁盘读数据：** DMA直接将其送到主存，如果有些被DMA写过的单元在cache中，那么以后CPU读取这些单元的时候，就会得到一个老的值。
    *   **向磁盘写数据 (写回策略)：** 当一个新的值在cache中写入时，这个值并未被马上写回存储器，而此时若DMA直接从主存读，那么读的可能是老的值。
    *   **解决方法：**
        1.  **让I/O活动通过cache进行：** 保证I/O读时能读到最新的数据，而I/O写时能更新cache中的任何数据。但代价非常大，因为一般I/O数据很少马上要用到，如果这样的数据把CPU正在使用的有用数据替换出去，会影响cache的命中率，对CPU的性能带来很多负面影响。
        2.  **让操作系统在I/O读时有选择地使某些cache块无效，而在I/O写时迫使cache进行一次写回操作 (cache刷新)：** 这种方式需要少量硬件支持。因为大部分cache刷新操作仅发生在DMA数据块访问时，而DMA访问又不经常发生，所以，如果软件能方便而有效地实现这种方法的话，可能是比较有效的一种。
        3.  **通过一个硬件机制来选择被刷新或使无效的cache项：** 这种用硬件方式来保证cache一致性的方式大多被用在多处理器系统中。

**9.5.4 通道和I/O处理器方式**

在大型计算机系统中，外围设备的数量、种类较多，为了在处理I/O请求时进一步减少中断处理次数和处理器占用时间，通常把对外设的管理和控制工作从CPU中分离出来，使I/O控制器更具智能化。这种I/O控制器称为通道控制器或I/O处理器。

*   **通道控制器和I/O处理器可独立执行一系列I/O操作**，这些I/O操作序列被称为通道程序，这些程序可能被存储在通道或I/O处理器自己的存储器，或在共享的主存中，由通道或I/O处理器从主存中取出执行。
*   当CPU执行到I/O请求时，操作系统要为I/O读写操作组织相应的传送参数或通道程序，通道或I/O处理器通过通道程序执行相应的操作，只有当整个通道程序都执行完后，才会中断CPU。

1.  **通道的基本概念**
    *   通道 (Channel, 简写为CH) 是一种专门的I/O控制器。
    *   **与DMA方式的区别：**
        *   DMA方式通过DMA控制器控制总线，在外设和主存之间直接实现I/O传送。
        *   通道通过执行通道程序对I/O操作管理。
    *   **对CPU而言：** 通道比DMA具有更强的独立处理I/O的能力。
    *   DMA控制器通常只控制一台或多台同类的高速设备；而通道可控制多台同类或不同类的设备。
    *   **系统结构 (图9.50)：** 主机 — 通道 — 设备控制器 — 外设 四级结构。系统中可有多个通道，每个通道可接多个设备控制器，一个设备控制器可管理多个设备。
	    * ![[image-345.png]]
    *   **CPU对通道的控制：**
        *   **(1) 执行I/O指令：** 操作系统按约定的格式准备好命令和数据，编制好通道程序，当需要进行I/O操作时CPU通过执行I/O指令（例如START I/O, TEST I/O, HALT I/O等）来启动通道。通道被启动后，从主存指定单元开始处取出通道程序执行。I/O指令是一种管态（特权）指令，在用户程序中不能使用。I/O指令应给出通道开始工作所需的全部参数，如通道执行何种操作，在哪个通道和设备上进行操作等。I/O指令和CPU的其他指令形式相同，由操作码和地址码组成。CPU启动通道后，通道和外部设备将独立进行工作，无须CPU干预。
        *   **(2) 处理来自通道的中断请求：** 当通道和外设发生异常或结束处理时，通道采用“中断”方式向CPU报告。通道是介于主机和设备控制器之间的机构，它一方面接受CPU的控制，向CPU发出相应的中断请求信号；另一方面它要负责对设备控制器的管理。
    *   **通道基本职能：**
        1.  接受CPU的I/O指令，按CPU的要求与指定的外设通信。
        2.  从内存读取通道程序并执行，从而向设备控制器和设备发送各种控制命令。
        3.  组织外设和内存间的数据传送，并根据要求提供中间缓存。
        4.  从外设得到设备的状态信息，并与通道本身的状态信息一起保存，并根据要求将状态信息送内存固定单元。
        5.  将外设的中断请求和通道本身的中断请求，按序并及时报告给CPU。
    *   **设备控制器：** 类似于I/O接口，它接受通道的命令，并向设备发出控制信号，是通道对外设实现传输控制的执行机构。一个设备控制器可以控制多个同类的设备。

2.  **通道的种类 (按数据传送方式)**
    *   **字节多路通道：** 采用字节交叉传送方式进行数据传送，适合于连接多个低速I/O设备。这类设备传送一个字节的时间较短，而相邻字节之间数据准备时间较长。在字节多路通道的控制下，多台低速I/O设备以字节为单位，分时使用通道，轮流传送数据，实现多台I/O设备间的并行，以提高通道利用率，所以数据传输率是每个设备的传输率之和。字节多路通道由多个子通道构成，每个子通道并行工作，各服务于一个设备控制器。每个子通道中包含字符缓冲器、状态/控制寄存器以及通道参量（如字节计数值、内存地址等）、主存单元的地址指针等。
    *   **选择通道：** 用于对高速设备进行控制。对于高速设备，通道难以同时对多个设备进行控制，所以在一段时间内选择通道只执行一个设备的通道程序，为单个设备服务，采用“成组”方式传送。某个设备一旦被选中便独占通道，直到传送完毕才释放通道，所以传输速率高。选择通道可接多台同类设备，通道中包含一个参数寄存器，用于记录I/O操作所需的通道参量。
    *   **成组多路通道：** 通道在传输期间，只为一台高速设备服务，这是合理的。但有些高速设备机械辅助操作的时间较长，如磁盘寻道、磁带走带等，因此这期间的等待是一种浪费。可以考虑采用成组多路方式进行传送，多台设备以定长数据块为单位分时使用传输通路，轮流传送数据块。这种通道称为成组多路通道。它适用于控制磁盘机和磁带机之类的外设。

3.  **通道程序**
    *   由若干通道命令字 (CCW - Channel Command Word) 构成，它是一组功能有限的I/O操作指令，能指定通道I/O操作所需的参量，并完成数据传送操作。
    *   CCW一般包括操作命令码、数据在内存的首址、传送数据个数和控制标志字段等。
    *   **IBM 370和IBM 4300的通道命令字 (双字) 结构：**
	    * ![[image-346.png]]
        *   **操作码字段：** 指出设备所进行的操作。
        *   **内存地址字段：** 在执行读、反读、写、测试等操作时给出数据在主存中的首地址。
        *   **标志特征字段：** 共有5位标志特征位。
            *   **数据链特征 (CD) 和命令链特征 (CC)：** 若CD=0、CC=0，则说明本指令是通道程序的最后一条指令。若CD=1、CC=0，则说明本指令与下一条指令的操作码相同。若CD=0、CC=1，则说明本指令和下条指令的操作码不同。
            *   **封锁错误长度特征 (SLI)：** 为1时忽略长度错误。
            *   **封锁写入主存特征 (SKIP)：** 为1时只执行外设相应的操作，而不把数据写入主存。
            *   **程序控制中断特征 (PCI)：** 为1时产生I/O中断请求。
        *   **计数值字段：** 指定传送的数据个数。
    *   **通道程序示例 (表9.4 - 磁带与主存数据传送)：** 假定CPU调用时已由I/O指令启动了通道与磁带机，则通道从主存某固定单元中读出通道地址字CAW。然后再从CAW中取出通道程序首址，开始执行通道程序。
	    * ![[image-347.png]]
        *   **(1) 倒带：** 由于磁头可能处于磁带的中部，故应先倒带，使磁带反转到起始端。
        *   **(2) 走带：** 磁带正向越过3个数据块（记录区），但不读出。
        *   **(3) 读：** 读出256个字节的数据，写入首址为31B0H的主存缓冲区。
        *   **(4) 读带但不写入主存：** 由于第(3)条通道指令中，链接特征为CD=1、CC=0，所以第(4)条指令的操作与第(3)条相同，仍为读出。但封锁写入主存位SKIP=1，所以不写入主存。其作用相当于正向越过256字节的磁带长度。
        *   **(5) 读带：** 从磁带中读出512个字节的数据，写入首址为5000H的主存缓冲区。根据链接特征位，第5条是本通道程序的最后一条，至此结束。

4.  **输入输出处理机 (IOP - I/O Processor)**
    *   输入输出处理机方式是通道方式的进一步发展。
    *   **通道结构的输入输出处理机 (IOP)：** 与通道方式一样，IOP也通过执行通道程序对外设进行控制，能和CPU并行工作，提供了DMA控制能力。
    *   **与通道的区别：**
        *   通道只有功能有限的、面向外设控制和数据传送的指令系统；而IOP有自己专用的指令系统，不仅可用于进行外设控制和数据传送，而且可进行算术运算、逻辑运算、字节变换、测试等。
        *   通道方式下，通道程序存于和CPU公用的主存中；而IOP有自己单独的存储器，并可访问系统内存。
        *   通道方式下，许多工作仍然需要CPU实现；而IOP有自己的运算器和控制器，能处理传送出错及异常情况，能对传送的数据格式进行转换，能进行整个数据块的校验等。
    *   **分级I/O系统：** 具有IOP的I/O系统是一个分级的I/O系统。用户程序和I/O系统是隔离开的，用户程序只“看见”最高层。当CPU执行到用户程序中要求进行某种输入输出操作的指令时，它就发一个I/O请求，调用操作系统中的I/O管理程序。I/O管理程序接受到I/O请求后，就组织这次I/O操作所需的数据/控制信息块，包括总线请求方式、总线物理宽度、通道操作命令字和通道程序的参数块（设备地址、数据地址、通道程序指针、回送结果单元等）等，并放在主存公共区域，然后启动IOP中的通道工作。IOP从主存公共信息区读取CPU放在该处的控制信息，并根据CPU预先设置的信息选择一个指定的通道程序执行。
    *   **外围处理器 (PPU - Peripheral Processing Unit) 方式：** 另一种输入输出处理机系统结构。在大型计算机系统中，有时选用通用计算机担任PPU，它基本上独立于主CPU而工作，也有自己的指令系统，可进行算术/逻辑运算、主存读写和与外设交换信息等。
    *   **输入输出处理机的特点：** 一种特殊的装置，有特定的任务，所以相对于对等多处理器，其并行性很有限，它只用于传输信息、或对信息进行简单的加工和格式转换等。

---