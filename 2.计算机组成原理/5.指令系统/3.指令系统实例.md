
指令系统设计是计算机系统设计的核心工作，不同机器的指令集体系结构 (ISA) 差异很大。了解不同类型的 ISA，对计算机系统设计工作会有很大帮助。以下简单介绍几种有代表性的指令系统实例。
### *5.3.1 Pentium 指令系统
Pentium 处理器是 IA-32 体系结构的典型代表，采用 CISC 风格设计。
**1. 指令格式**
Pentium 采用可变长指令格式，指令长度为 1~15 字节，由**前缀 (Prefix)** 和 **指令 (Instruction)** 两部分组成。
*   **(1) 前缀 (Prefix):**
    *   位于指令操作码前，但并不是每条指令都必须有。
    *   包括以下 4 类：
        *   **① 指令前缀 (Instruction Prefix):** 由 LOCK 前缀和重复操作前缀组成。
            *   LOCK 前缀：规定是否对共享存储器以独占方式使用。
            *   重复操作前缀：表示重复操作的类型，有 REP、REPZ、REPE、REPNZ、REPNE 等几种。
        *   **② 段前缀 (Segment Prefix):** 如果有段前缀，则指令采用段前缀指定的段寄存器，而不用缺省段寄存器。
        *   **③ 操作数长度前缀 (Operand-Size Prefix):** 如果有该前缀，则操作数长度将采用它规定的长度。
        *   **④ 地址长度前缀 (Address-Size Prefix):** 如果有该前缀，则地址长度将采用它规定的而不是缺省的长度。
    *   (图5.6 Pentium 指令前缀的字节数：指令前缀、段前缀、操作数长度、地址长度均为0或1字节)
	    * ![[image-206.png]]
*   **(2) 指令 (Instruction):**
    *   指出操作类型和操作数或操作数地址。
    *   (图5.7 Pentium 指令格式：操作码[1或2字节]、寻址方式[0或1字节]、SIB[0或1字节]、偏移量[1,2,4字节]、直接数据[立即数])
	    * ![[image-207.png]]
    *   指令部分包含以下几个字段：
        *   **① 操作码 (Opcode):** 1~2 字节。指定操作性质并给出以下信息：数据长度是字节还是字(16位)；寻址方式字节中 Reg/OP 字段指定的寄存器是源还是目标；指令中如果有立即数，则是否对它进行符号扩展。
        *   **② 寻址方式字节 (ModR/M Byte):** 由 Mod、Reg/OP 和 R/M 三个字段组成。
            *   Mod 和 R/M 联合指定 8 种寄存器寻址和 24 种变址寻址方式。
            *   Reg/OP 指定寄存器号（作为操作数）或 3 位扩展操作码。
        *   **③ SIB 字节 (Scale-Index-Base Byte):** 由 SS (2位)、Index (3位)、Base (3位) 三部分组成。
            *   SS (Scale Factor)：指定比例系数（变址寻址方式时，变址寄存器内容要乘以该系数）。
            *   Index：指定变址寄存器号。
            *   Base：指定基址寄存器号。
        *   **④ 偏移量 (Displacement):** 指令中如果有偏移量，可以是 1、2 或 4 个字节。
        *   **⑤ 直接数据 (Immediate Data):** 指令中如果有立即数，可以是 1、2 或 4 个字节。
**2. 寻址方式**
操作数来源有三种：立即数、寄存器和存储单元。
有 32 位、16 位和 8 位三种长度的通用寄存器。
当操作数为存储单元内容时，需要进行地址转换。Pentium 采用**段页式存储管理机制**：
1.  先通过**分段方式**将虚拟(逻辑)地址转换为**线性地址 (Linear Address, LA)**。
2.  然后再用**分页方式**将线性地址转换为**内存(物理)地址**。
指令中必须显式或隐式地给出以下信息：
*   **(1) 段寄存器 SR (Segment Register):** 可用段前缀显式给出，也可缺省。
*   **(2) 8/16/32 位偏移量 A:** 由偏移量字段显式给出。
*   **(3) 基址寄存器 B:** 由 SIB 中 Base 字段显式给出，任意通用寄存器皆可。
*   **(4) 变址寄存器 I:** 由 SIB 中 Index 字段显式给出，除 ESP 外的任意通用寄存器皆可。
有**比例变址**和**非比例变址**。比例变址时，要乘以比例因子 S (由 SIB 中 SS 字段给出)，其含义为操作数的字节个数。
**(表5.1 Pentium 的寻址方式)**
![[image-208.png]]

**(图5.8 Pentium 处理器线性地址形成过程)**
	![[image-209.png]]
1.  根据段寄存器中的**段选择符 (Segment Selector)**，得到一个段表项。
2.  根据段表项中的**段描述符 (Segment Descriptor)**，得到**段基址 (Segment Base)**、段长度界限、段存取权限等。
3.  再将基址值、比例变址值、偏移量与段基址相加，得到线性地址。
4.  可以根据段限和存取权限判断是否“地址越界”和“访问超限”，以实现存储保护。
5.  形成线性地址后，再通过分页方式实现从线性地址到物理地址的转换（此步骤对程序员透明）。
此外，Pentium 指令系统中的调用指令自动把返回地址压到栈中，并有专门的入栈 (push) 和出栈 (pop) 指令，能自动修改栈指针。运算类指令能直接生成条件码，存放在标志寄存器 EFLAGS 中，而且运算类指令中的一个操作数可以来自主存单元。
### *5.3.2 Power PC 指令系统
Power PC 是 RISC 风格处理器，因此其指令格式和寻址方式较为简单和规整。
**1. 指令格式**
Power PC 采用 32 位定长指令字结构。采用这种规整指令格式，有利于简化指令执行部件的设计。
**(表5.2 Power PC 指令格式简表)**
	![[image-210.png]]
*   所有指令的最高 6 位都是操作码。有些指令将其他一些位 (XO 字段) 作为操作码扩展。
*   取数/存数、算术运算和逻辑运算指令在操作码后有 2~3 个 5 位的寄存器字段，各自选取 32 个寄存器之一。
*   **(a) 转移指令:**
    *   条件转移：选项、CR位、转移位移量 (A/L 标志) 或 通过计数器/链接寄存器间接 (L 标志)
    *   无条件转移：直接转移地址 (L 标志)
    *   **链接指示 (L):** 表示是否将该指令随后一条指令的地址 (返回地址) 送入链接寄存器。
    *   **绝对/相对指示 (A):** 用于指明地址是绝对地址还是相对于 PC 的地址。
    *   **CR 位:** 指明转移条件对应条件寄存器 (标志寄存器) 中哪一位标志。
    *   **选项字段:** 指定按什么条件转移。
*   **(b) 条件寄存器逻辑指令:** CR、目标位、源位、源位、与/或/异或等。
*   **(c) 取数/存数指令:**
    *   间接：目标寄存器、基址寄存器、位移
    *   间接变址：目标寄存器、基址寄存器、变址寄存器、大小/符号/更新 (XO 扩展)
    *   间接：目标寄存器、基址寄存器、位移 (XO 扩展)
*   **(d) 整数算术/逻辑运算及环移/平移指令:**
    *   算术/逻辑：目标寄存器、源寄存器、源寄存器 (O 标志，ADD/SUB等，R 标志) 或 有符号立即数 (ADD/SUB等，R 标志)
    *   环移/平移：目标寄存器、源寄存器、移位量/源寄存器、屏蔽起点/移位类型/屏蔽终点/屏蔽字 (R/S/XO 标志)
    *   **R 标志:** 用来表示是否将运算结果的有关标志写入到条件寄存器中，这在条件转移预测时很有用。
    *   **O 标志:** 将溢出标志记录到 XER 中。
*   **(e) 浮点运算指令:** 目标寄存器、源寄存器、源寄存器、源寄存器、浮点加等 (R 标志)。
    *   浮点运算指令有三个源寄存器字段，多数情况只用到两个。少数指令将两个数相乘然后加上或减去第三个数 (即乘加指令和乘减指令)，这类指令主要用于 3D 图形的坐标转换和矩阵内积计算。
**2. 寻址方式**
Power PC 采用的寻址方式较简单，主要有以下几种：
*   **(1) 取数/存数指令的寻址方式:**
    *   **间接寻址 (Register Indirect):** EA = (BR) + D
        *   BR 为基址寄存器 (任意通用寄存器)。
        *   D 为偏移量 (16 位带符号数)。
    *   **间接变址寻址 (Register Indirect with Index):** EA = (BR) + (IR)
        *   IR 为变址寄存器 (任意通用寄存器)。
*   **(2) 转移指令的寻址方式:**
    *   **① 绝对寻址方式:** 无条件转移和条件转移指令分别给出 24 位和 16 位地址，这些地址均扩展为 32 位后形成转移地址。扩展方法是：最低端补两个零，高端进行符号扩展。
    *   **② 相对寻址方式:** 如果是无条件转移，指令给出 24 位地址，按前述方法扩展后和 PC 相加即为转移目标地址；如果是条件转移，指令给出 14 位地址，按前述方法扩展后和 PC 相加作为转移目标地址。
    *   **③ 间接寻址方式:** 下条指令的有效地址存放于链接寄存器或计数寄存器中。
*   **(3) 算术指令的寻址方式:**
    *   整数算术指令可采用**寄存器寻址**或**立即寻址**，立即数是 16 位有符号数。
    *   浮点算术指令只可采用**寄存器寻址**。
### *5.3.3 MMX 和 SIMD 指令技术
在多媒体应用中，图形、图像、视频和音频处理过程存在大量具有共同特征的操作。例如：
*   ① 短整数类型的并行操作 (如 8 位图像像素和 16 位音频信号)。
*   ② 频繁的乘法累加 (如 FIR 滤波、矩阵运算)。
*   ③ 短数据的高度循环运算 (如 FFT、DCT)。
*   ④ 计算密集型算法 (如三维图形、视频压缩)。
*   ⑤ 高度并行操作 (如图像处理)。
为提高上述共性操作运算能力，Intel 在 IA-32 指令系统基础上，设计了一套新增指令集，并对 CPU 内部结构进行了扩充与改进，称为 **MMX (MultiMedia eXtensions) 技术**。MMX 指令于 1997 年首次运用于 P54C Pentium 处理器 (多能奔腾)，共有 57 条指令。
MMX 技术包含以下几个方面：
*   **(1) 引入新的数据类型和通用寄存器:**
    *   主要数据类型为**定点紧缩 (Packed) 整数**，定义了以下 4 种新的 64 位数据类型：
        *   ① **紧缩字节 (Packed Byte):** 紧缩成 8 个字节。
        *   ② **紧缩字 (Packed Word):** 紧缩成 4 个字 (每字 16 位)。
        *   ③ **紧缩双字 (Packed Doubleword):** 紧缩成两个双字。
        *   ④ **四字 (Quadword):** 一个 64 位字。
    *   为便于 MMX 指令对上述数据类型进行操作，CPU 中新增 8 个 64 位通用寄存器 **MX0 ~ MX7**。这些寄存器可用来实现数据运算，但不能用于存储器寻址。
*   **(2) 采用 SIMD (Single Instruction Multi Data) 技术:**
    *   单条指令同时并行处理多个数据元素 (如 8 个字节，或 4 个字，或两个双字，或一个 64 位字)，这对提高运算速度非常有利。例如，一条指令可以完成图像中 8 个像素的并行操作。
*   **(3) 引入饱和 (Saturation) 运算:**
    *   在上述四种 64 位数据类型的运算过程中，引入两类运算模式：**环绕运算 (Wrap-around Arithmetic)** 和 **饱和运算 (Saturation Arithmetic)**。
    *   **环绕运算 (非饱和运算):** 上溢或下溢的结果被截取，即进位被丢掉，仅保留低有效位的值。例如 F3H + 1DH = 10H (8位无符号数)。在多媒体处理中，这种运算模式有时会产生问题。
    *   **饱和运算:** 当发生上溢或下溢时，其运算结果取各类数据值域的最大值或最小值。
        *   例如，图像插值运算，若 a 点亮度为 F3H，b 点为 1DH，用环绕运算，线性插值为 10H/2 = 08H，新插入点亮度比 b 还低，不合理。
        *   采用无符号数饱和运算模式计算 F3H + 1DH 时，因为加法运算发生上溢 (8位无符号数最大值为 FFH)，所以最终结果为 FFH，其线性插值结果为 FFH/2 = 7FH，作为插值结果比较合理。
    *   随着多媒体处理软件对处理器性能要求越来越高，Intel 在多能奔腾以后的处理器中加入了更多**流式 SIMD 扩展 (Stream SIMD Extension, SSE)** 指令集，包括 SSE、SSE2、SSE3、SSSE3 等。