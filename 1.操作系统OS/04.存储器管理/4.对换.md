
**别名 (Alias):** 交换技术 (Swapping Technology)
**起源 (Origin):** 最早用于麻省理工学院的单用户分时系统 CTSS 中。
**引入原因 (Reason for Introduction in CTSS):** 当时计算机的内存都非常小，为了使该系统能分时运行多个用户程序而引入了对换技术。

**早期对换机制 (Early Swapping Mechanism):**
*   系统把所有的用户作业存放在磁盘上。
*   每次只能调入一个作业进入内存。
*   当该作业的一个时间片用完时，将它调至外存的**后备队列 (Ready Queue on Disk)** 上等待。
*   再从后备队列上将另一个作业调入内存。
*   这就是最早出现的分时系统中所用的对换技术，现在已经很少使用。

**现代对换技术 (Modern Swapping Technology):**
*   **前提条件 (Prerequisites):** 要实现内、外存之间的对换，系统中必须：
    *   有一台 **I/O 速度较高的外存 (High-speed I/O Secondary Storage)**。
    *   其容量也必须足够大，能容纳正在分时运行的所有用户作业。
    *   目前最常使用的是大容量磁盘存储器。
*   **应用场景 (Application Scenarios):** 主要介绍目前在多道程序环境中广泛使用的对换技术。

---

## 4.4.1 多道程序环境下的对换技术 (Swapping Technology in Multiprogramming Environments)

### 1. 对换的引入 (Introduction of Swapping)

*   **内存紧张问题 (Memory Shortage Problem in Multiprogramming):**
    *   **一方面:** 内存中的某些进程由于某事件尚未发生而被阻塞运行，但它却占用了大量的内存空间；甚至有时可能出现在内存中所有进程都被阻塞，而无可运行之进程，迫使 CPU 停止下来等待的情况。
    *   **另一方面:** 却又有着许多作业，因内存空间不足，一直驻留在外存上，而不能进入内存运行。
*   **资源浪费与吞吐量下降 (Resource Waste and Throughput Decrease):** 显然这对系统资源是一种严重的浪费，且使系统吞吐量下降。
*   **解决方案 (Solution):** 在系统中又增设了**对换 (也称交换) 设施 (Swapping Facility)**。
*   **对换定义 (Definition of "Swapping"):** 指把内存中**暂时不能运行的进程**或者**暂时不用的程序和数据**换出到外存上，以便腾出足够的内存空间，再把已具备运行条件的进程或进程所需要的程序和数据换入内存。
*   **对换的意义 (Significance of Swapping):**
    *   改善内存利用率的有效措施。
    *   可以直接提高处理机的利用率和系统的吞吐量。

#### 对换技术的演进与应用 (Evolution and Application of Swapping Technology):

*   自从 20 世纪 60 年代初期出现“对换”技术后，便引起了人们的重视。
*   **UNIX 系统:** 早期的 UNIX 系统中已引入了对换功能，该功能一直保留至今。各个 UNIX 版本实现对换功能的方法也大体上是一样的：
    *   在系统中设置一个**对换进程 (Swapper Process)**。
    *   由它将内存中暂时不能运行的进程调出到磁盘的**对换区 (Swap Area)**。
    *   同样也由该进程将磁盘上已具备运行条件的进程调入内存。
*   **Windows OS:** 也具有对换功能。如果一个新进程在装入内存时发现内存不足，可以将已在内存中的老进程调至磁盘，腾出内存空间。
*   **广泛应用 (Wide Application):** 由于对换技术的确能有效地改善内存的利用率，故现在已被广泛地应用于 OS 中。

### 2. 对换的类型 (Types of Swapping)

在每次对换时，都是将一定数量的程序或数据换入或换出内存。根据每次对换时所对换的数量，可将对换分为如下两类：
*   **(1) 整体对换 (Entire Process Swapping / Whole Process Swapping):**
    *   **与中级调度的关系 (Relation to Medium-Term Scheduling):** 在第三章中介绍处理机调度时已经说明了，处理机**中级调度 (Medium-Term Scheduler)** 实际上就是存储器的对换功能。
    *   **目的 (Purpose):** 用来解决内存紧张问题，并可进一步提高内存的利用率和系统的吞吐量。
    *   **单位 (Unit):** 由于在中级调度中对换是以**整个进程**为单位的，故称之为“进程对换”或“整体对换”。
    *   **应用 (Application):** 这种对换被广泛地应用于多道程序系统中，并作为处理机中级调度。
*   **(2) 页面(分段)对换 (Page/Segment Swapping):**
    *   **单位 (Unit):** 如果对换是以进程的一个“页面”或“分段”为单位进行的，则分别称之为“页面对换”或“分段对换”，又统称为“部分对换”。
    *   **目的 (Purpose):** 这种对换方法是实现后面要讲到的**请求分页 (Demand Paging)** 和**请求分段 (Demand Segmentation)** 式存储管理的基础，其目的是为了支持**虚拟存储系统 (Virtual Memory System)**。
    *   **本章重点 (Focus of this Chapter):** 此处我们只介绍进程对换，而分页或分段对换，将放在虚拟存储器中介绍。

#### 实现进程对换的功能要求 (Functional Requirements for Process Swapping):

*   对对换空间的管理 (Management of Swap Space)
*   进程的换出 (Process Swapping Out)
*   进程的换入 (Process Swapping In)

---

## 4.4.2 对换空间的管理 (Management of Swap Space)

### 1. 对换空间管理的主要目标 (Main Goals of Swap Space Management)

在具有对换功能的 OS 中，通常把磁盘空间分为**文件区 (File Area)** 和**对换区 (Swap Area)** 两部分。
*   **(1) 对文件区管理的主要目标 (Main Goals for File Area Management):**
    *   文件区占用磁盘空间的大部分，用于存放各类文件。
    *   由于通常的文件都是较长时间地驻留在外存上，对它访问的频率是较低的。
    *   故对文件区管理的主要目标是**提高文件存储空间的利用率**，然后才是提高对文件的访问速度。
    *   因此，对文件区空间的管理采取**离散分配方式 (Discrete Allocation)**。
*   **(2) 对对换区管理的主要目标 (Main Goals for Swap Space Management):**
    *   对换空间只占用磁盘空间的小部分，用于存放从内存换出的进程。
    *   由于这些进程在对换区中驻留的时间是短暂的，而对换操作的频率却较高。
    *   故对对换空间管理的主要目标，是**提高进程换入和换出的速度**，然后才是提高文件存储空间的利用率。
    *   为此，对对换区空间的管理采取**连续分配方式 (Contiguous Allocation)**，较少考虑外存中的碎片问题。

### 2. 对换区空闲盘块管理中的数据结构 (Data Structures for Managing Free Blocks in Swap Space)

*   为了实现对对换区中的空闲盘块的管理，在系统中应配置相应的数据结构，用于记录外存对换区中的空闲盘块的使用情况。
*   其数据结构的形式与内存在动态分区分配方式中所用数据结构相似，即同样可以用**空闲分区表 (Free Partition Table)** 或**空闲分区链 (Free Partition Chain)**。
*   在空闲分区表的每个表目中，应包含两项：对换区的首址及其大小，分别用盘块号和盘块数表示。

### 3. 对换空间的分配与回收 (Allocation and Reclamation of Swap Space)

*   由于对换分区的分配采用的是连续分配方式，因而对换空间的分配与回收与动态分区方式时的内存分配与回收方法雷同。
*   其分配算法可以是首次适应算法、循环首次适应算法或最佳适应算法等。
*   具体的分配操作也与图 4-8 中内存的分配过程相同。
*   对换区的回收操作可分为四种情况：
    *   (1) 回收分区与插入点的前一个空闲分区 F₁ 相邻接；
    *   (2) 回S收分区与插入点的后一个空闲分区 F₂ 相邻接；
    *   (3) 回收分区同时与插入点的前、后两个分区邻接；
    *   (4) 回收分区既不与 F₁ 邻接，又不与 F₂ 邻接。
*   对上述这几种情况的处理方法也与动态分区方式相同，故在这里不再赘述。

---

## 4.4.3 进程的换出与换入 (Process Swapping Out and Swapping In)

*   **触发条件 (Triggering Condition):** 当内核因执行某操作而发现内存不足时 (例如，当一进程由于创建子进程而需要更多的内存空间，但又无足够的内存空间等情况发生时)，便调用 (或唤醒) **对换进程 (Swapper Process)**。
*   **主要任务 (Main Task of Swapper Process):** 实现进程的换出和换入。

### 1. 进程的换出 (Process Swapping Out)

*   对换进程在实现进程换出时，是将内存中的某些进程调出至对换区，以便腾出内存空间。
*   换出过程可分为以下两步：
    *   **(1) 选择被换出的进程 (Selecting the Process to be Swapped Out):**
        *   对换进程将检查所有驻留在内存中的进程。
        *   首先选择处于**阻塞状态 (Blocked State)** 或**睡眠状态 (Sleeping State)** 的进程。
        *   当有多个这样的进程时，应当选择**优先级最低**的进程作为换出进程。
        *   在有的系统中，为了防止低优先级进程在被调入内存后很快又被换出，还需考虑进程在内存的**驻留时间 (Residence Time)**。
        *   如果系统中已无阻塞进程，而当前的内存空间仍不足以满足需要，便选择优先级最低的**就绪进程 (Ready Process)** 换出。
    *   **(2) 进程换出过程 (Process Swapping Out Procedure):**
        *   应当注意，在选择换出进程后，在对进程换出时，只能换出**非共享的程序和数据段 (Non-shared Program and Data Segments)**。
        *   而对于那些共享的程序和数据段，只要还有进程需要它，就不能被换出。
        *   在进行换出时，应先**申请对换空间 (Request Swap Space)**。
        *   若申请成功，就启动磁盘，将该进程的程序和数据传送到磁盘的对换区上。
        *   若传送过程未出现错误，便可回收该进程所占用的内存空间，并对该进程的**进程控制块 (PCB)** 和**内存分配表 (Memory Allocation Table)** 等数据结构做相应的修改。
        *   若此时内存中还有可换出的进程，则继续执行换出过程，直到内存中再无阻塞进程为止 (或者已有足够空间)。

### 2. 进程的换入 (Process Swapping In)

*   对换进程将定时执行换入操作。
*   **过程 (Procedure):**
    *   它首先查看 PCB 集合中所有进程的状态，从中找出“就绪”状态但已换出的进程。
    *   当有许多这样的进程时，它将选择其中已换出到磁盘上**时间最久 (必须大于规定时间，如 2s)** 的进程作为换入进程。
    *   为它申请内存 (Request Memory)。
    *   如果申请成功，可直接将进程从外存调入内存。
    *   如果失败，则需先将内存中的某些进程换出，腾出足够的内存空间后，再将进程调入。
*   **后续操作 (Subsequent Operation):** 在对换进程成功地换入一个进程后，若还有可换入的进程，则再继续执行换入换出过程，将其余处于“就绪且换出”状态的进程陆续换入，直到内存中再无“就绪且换出”状态的进程为止，或者已无足够的内存来换入进程，此时对换进程才停止换入。

**对换效率的考量 (Consideration of Swapping Efficiency):**
*   由于要交换一个进程需要很多的时间，因此，对于提高处理机的利用率而言，它并不是一个非常有效的解决方法。
*   目前用得较多的对换方案是，在处理机正常运行时，并不启动对换程序。但如果发现有许多进程在运行时经常发生缺页且显现出内存紧张的情况，才启动对换程序，将一部分进程调至外存。如果发现所有进程的缺页率都已明显减少，而系统的吞吐量已下降时，则可暂停运行对换程序。

---