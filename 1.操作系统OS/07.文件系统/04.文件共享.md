
**核心概念：**
文件共享是指系统允许多个用户（或进程）共同使用同一份文件副本。这在现代计算机系统中是必不可少的功能，可以避免每个需要该文件的用户都各自保存一份副本，从而节省存储空间，并方便协作。
**文件共享的发展：**
文件共享的范围不断扩大，从单机系统内的共享，发展到多机系统（如局域网）的共享，再到计算机网络范围（如互联网）的共享，甚至实现全球范围的文件共享。

**早期的文件共享方法（了解即可）：**
*   绕弯路法
*   连访法
*   利用基本文件实现文件共享的方法

**7.4.1 基于有向无环图实现文件共享 (DAG - Directed Acyclic Graph)**

1.  **有向无环图 (DAG) 的引入**
    *   **严格树形结构的限制**：在严格的树形目录结构中，每个文件或目录只允许有一个父目录。这意味着文件属于特定的用户或目录，其他用户想访问必须通过其属主目录，这种共享是不对称的。
    *   **DAG 的改进**：允许一个文件或子目录可以有多个父目录。这意味着多个不同用户的目录可以同时指向（拥有）同一个文件或子目录，从而实现对称的文件共享。用户可以直接通过自己的目录路径访问共享文件，无需再通过原始属主。
    * ![[Pasted image 20250531144653.png]]
    *   *(参考图 7-13 有向无循环图目录层次)*
        *   示例解读：文件 F8 有三个父目录 D5, D6, D3。其中 D5 和 D3 甚至使用了相同的名字 `p` 来指向 F8。目录 D6 有两个父目录 D2 和 D1。

2.  **链接的建立与问题**
    *   **如何建立链接**：当多个用户要共享一个子目录或文件时，必须将该共享对象链接到这些用户的父目录中。
    *   **如果目录项直接存物理地址**：
        *   **问题**：如果在建立链接时（例如 D5 链接到 F8），将 F8 的物理地址（如盘块号）直接拷贝到 D5 的目录项中。如果之后 F8 的内容发生改变（如 `Append` 操作导致增加新的盘块），这些新增加的盘块信息只会更新在最初创建 F8 的那个目录项（如 D6 指向 F8 的条目）所关联的元数据中。
        *   **结果**：其他共享用户（如通过 D5 访问 F8 的用户）将无法看到这些新增内容，因为他们的目录项中记录的仍然是旧的、未更新的盘块信息。这种变化对其他共享用户是不可见的，导致共享不一致。

3.  **利用索引结点 (Inode) 解决共享一致性问题**
    *   **核心思想**：将文件的物理地址、属性等元数据信息从目录项中分离出来，存放在一个独立的数据结构——**索引结点 (Inode)** 中。
    *   **目录项的改变**：目录项中不再存放文件的完整元数据，只存放**文件名**和指向该文件对应**索引结点的指针 (或编号)**。
    * ![[Pasted image 20250531144718.png]]
    *   *(参考图 7-14 基于索引结点的共享方式)*
    *   **共享实现**：当多个用户共享同一个文件时，他们的目录中都有一个指向该文件**唯一索引结点**的目录项。
    *   **数据一致性**：任何用户对共享文件所做的修改（如 `Append`、内容修改等导致盘块号或文件长度改变），都会直接反映在该文件唯一的索引结点中。由于所有共享用户都通过这个索引结点来访问文件，因此这些改变对所有共享用户都是可见的，保证了数据的一致性。

4.  **链接计数 (Link Count)**
    *   **作用**：在索引结点中增加一个**链接计数器 `count`**，用于记录有多少个目录项指向（链接到）本索引结点（即有多少个“文件名”指向这个文件实体）。
    *   **创建文件时**：当用户 C 创建一个新文件时，他是该文件的所有者，`count` 置为 1。
    *   **共享文件时**：当用户 B 要共享此文件时，在用户 B 的目录中增加一个目录项，其指针指向该文件的索引结点。此时，文件主仍然是 C，但索引结点中的 `count` 变为 2。
    *   **删除文件时**：
        *   **用户 C (文件主) 试图删除文件**：如果 `count` > 1 (例如 `count`=2，表示还有用户 B 在共享)，此时**不能**真正删除文件和其索引结点。否则，用户 B 的目录项指针会悬空，若 B 正在写操作则可能导致错误。
        *   **正确的处理**：当一个用户删除指向共享文件的目录项时，只是将该目录项删除，并将索引结点中的 `count` 减 1。
        *   **真正删除文件**：只有当 `count` 减为 0 时，才表示没有任何目录项指向该文件，此时系统才会真正回收该文件占用的磁盘空间和其索引结点。
    *   *(参考图 7-15 进程 B 链接前后的情况，以及拥有者删除文件后的情况)*
    * ![[Pasted image 20250531144756.png]]
        *   图示解释：
            *   **链接前**：C 是 owner, count=1。
            *   **B 建立链接后**：C 仍是 owner, count=2。
            *   **C (拥有者) 删除文件后**：C 的目录项删除，但文件实体和索引结点依然存在，count=1 (因为 B 还在使用)。B 仍然可以访问文件。



**7.4.2 利用符号链接实现文件共享 (Symbolic Linking)**

1.  **符号链接的基本思想**
    *   **允许多个父目录**：与基于 DAG 的共享类似，允许一个文件或子目录有多个父目录。
    *   **主父目录与链接父目录**：
        *   其中仅有一个父目录是**主父目录 (Primary Parent Directory)** 或 **属主父目录 (Owner Parent Directory)**。文件或子目录与主父目录的链接是“实链接”。
        *   其他的父目录是通过**符号链接 (Symbolic Link)** 的方式与之相链接的，这些父目录称为**链接父目录 (Linked Parent Directory)**。这些链接是“虚链接”或“符号链接”。
    *   *(参考图 7-16 使用符号链接的目录层次，对比图 7-13)*
    * ![[Pasted image 20250531144816.png]]
        *   图示解读：对比图 7-13，原图中指向 F8 的三条实线，在图 7-16 中，只有 D6 指向 F8 的是实线（D6 是 F8 的主父目录），而 D5 指向 F8 和 D3 指向 F8 的都变成了虚线（D5 和 D3 是链接父目录）。类似地，D6 的主父目录是 D2，D1 是 D6 的链接父目录。
    *   **好处**：文件的属主结构（通过实线连接的结构）仍然保持简单的树形结构，便于文件的删除、查找等管理操作。

2.  **如何利用符号链实现共享**
    *   **创建 LINK 类型文件**：当要建立一个符号链接时（例如，使链接父目录 D5 能共享文件 F8），系统会创建一个新的特殊类型的文件，称为 **LINK 类型文件**。这个 LINK 文件也取名为 F（与目标文件名相同，但类型不同），并存放在链接父目录 D5 中。
    *   **LINK 文件的内容**：这个新创建的 LINK 文件中只包含**被链接文件（目标文件）的路径名** (Pathname)。例如，D5 中的 LINK 文件 F 的内容就是 F8 的完整路径名 (e.g., `/D2/D6/F8`)。
    *   **访问过程**：
        1.  当用户通过链接父目录 D5 访问名为 F 的文件时，操作系统发现 F 是一个 LINK 类型文件。
        2.  操作系统读取 LINK 文件 F 的内容，即获得目标文件 F8 的路径名。
        3.  操作系统根据这个路径名去查找并访问真正的文件 F8。
        4.  然后对 F8 进行用户请求的读/写操作。
        5. 这样就实现了用户 B (通过 D5) 对文件 F (实际是 F8) 的共享
		
3.  **利用符号链实现共享的优点**
    *   **避免悬空指针**：
        *   文件主（拥有指向索引结点指针的用户）删除共享文件时，只是删除了主父目录中的目录项和文件的索引结点。
        *   其他共享用户（只有路径名）再次试图通过符号链接访问已被删除的共享文件时，系统会因为找不到该路径对应的文件而报告“文件未找到”的错误。
        *   此时，可以安全地删除这个失效的符号链接文件本身。
        *   不会出现像硬链接（基于索引结点）中文件主删除后，其他用户指针悬空的问题。
    *   **网络共享的便利性**：
        *   特别适用于网络环境。例如，HTML 文件中的超链接可以看作一种符号链接。
        *   通过这些链接符（路径名或 URL），可以将分布在世界各地机器上的文件链接起来，实现网络范围的文件共享。

4.  **利用符号链的共享方式存在的问题**
    *   **多次读盘开销**：当其他用户通过符号链接去读取共享文件时，系统需要：
        1.  读取符号链接文件本身，获取路径名。
        2.  根据路径名逐级查找目录，直到找到目标文件的索引结点。
        *   这个过程可能涉及多次磁盘I/O操作，开销较大，增加了启动磁盘的频率。
    *   **额外的索引结点开销**：每个符号链接本身也是一个文件，尽管简单，但仍需要为其配置一个索引结点，这会消耗一定的磁盘空间和系统资源。
    *   **文件名问题（共同问题）**：上述两种链接方式（硬链接和符号链接）都存在一个共同问题：每增加一个链接（无论是硬链接还是符号链接），共享文件就会多一个文件名（或路径）。这在遍历整个文件系统时（例如备份），可能会导致同一个共享文件被多次处理（如多次拷贝到磁带）。

