
**核心概念：**
文件保护是指采取一系列措施来确保文件系统中的数据安全，防止因各种原因导致的数据损坏、丢失或非授权访问。在现代计算机系统中，存储了大量宝贵信息，文件保护至关重要。
**影响文件安全性的主要因素：**

1.  **人为因素 (Human Factors)**：
    *   **有意行为**：恶意破坏、窃取、篡改数据。
    *   **无意行为**：误操作、程序bug导致数据损坏或丢失。
2.  **系统因素 (System Factors)**：
    *   系统某部分出现异常情况（如硬件故障、操作系统崩溃）导致数据破坏或丢失。
    *   磁盘作为主要存储介质，一旦出现故障，可能造成难以估量的损失。
3.  **自然因素 (Natural Factors)**：
    *   随着时间推移，存放在磁盘上的数据可能会因介质老化等原因逐渐消失或出错。
**文件保护的主要措施：**

1.  **存取控制机制 (Access Control Mechanisms)**：防止由人为因素（主要指非授权访问和误操作）造成的文件不安全。
2.  **系统容错技术 (System Fault Tolerance)**：防止因系统部分的故障所造成的文件不安全。
3.  **后备系统 (Backup Systems)**：防止由自然因素或灾难性事件所造成的文件不安全，也作为前两种措施失效后的最后防线。

**7.5.1 保护域 (Protection Domain)**

核心思想为了对系统中的资源进行保护，现代操作系统引入了“保护域”和“访问权”的概念。规定**每一个进程仅能在其所在的保护域内执行操作，并且只允许进程访问那些它拥有“访问权”的对象。


1.  **访问权 (Access Right)**
    *   **定义**：一个进程能对某个对象执行特定操作的权力。
    *   **对象 (Object)**：可以是：
        *   **硬件对象**：如CPU、内存区域、磁盘驱动器、打印机等。
        *   **软件对象**：如文件、程序、信号量、数据结构等。
    *   **操作 (Operation)**：针对不同对象，操作也不同。例如：
        *   对文件：读 (R)、写 (W)、执行 (E)、删除 (D)、追加 (A) 等。
        *   对打印机：打印。
    *   **表示**：每个访问权可以用一个有序对 `(对象名, 权集)` 来表示。
        *   `权集` 是允许对该对象执行的操作集合。
        *   例如：某进程对文件 F₁ 有读和写操作的权力，可表示为 `(F₁, {R, W})`。

2.  **保护域 (Protection Domain)**
    *   **定义**：一个进程对一组对象所拥有的访问权的集合。
    *   **作用**：“域”规定了进程所能访问的对象以及能对这些对象执行的操作。
    * ![[Pasted image 20250531144849.png]]
    *   *(参考图 7-17 三个保护域)*
        *   **域1**：可访问 F₁ (只读)、F₂ (读写)。
        *   **域2**：可访问 F₃ (只读)、F₄ (读写执行)、F₅ (读写)、Printer1 (使用)。
        *   **域3**：可访问 F₆ (读写执行)、某文件(只写，如图中1[W])、Plotter2 (使用)、Printer1 (使用)。
        *   注意：同一对象（如 Printer1）可以出现在多个域中，表示在这些域中运行的进程都能使用该对象。

3.  **进程和域间的静态联系 (Static Association)**
    *   **定义**：一个进程在其整个生命周期中，只与一个固定的保护域相关联。
    *   **缺点**：这种方式下，进程可用的资源是固定的。这可能会导致赋予进程的访问权超过其实际需要。
        *   例如：一个进程在开始时需要磁带机输入数据，在结束时需要打印机输出结果。如果采用静态域，则该域必须同时包含对磁带机和打印机的访问权，即使在大部分运行时间里，进程可能只需要其中一个或都不需要。这增大了潜在的安全风险（最小权限原则的违背）。

4.  **进程和域间的动态联系 (Dynamic Association)**
    *   **定义**：一个进程可以与多个保护域相关联，并且可以在其运行的不同阶段切换到不同的保护域。
    *   **实现**：将进程的运行分为若干个阶段，每个阶段关联一个特定的保护域。这样可以根据进程在不同阶段的实际需求，精确地赋予其所需的访问权。
    *   **域切换 (Domain Switching)**：采用动态联系方式的系统中，必须提供保护域切换功能，允许进程在不同运行阶段从一个保护域切换到另一个保护域。
        *   例如，上述例子可以分为三个阶段：
            *   **阶段1 (域 D₁)**：包含对磁带机的访问权。
            *   **阶段2 (域 D₂)**：既不含磁带机也不含打印机访问权（执行计算任务）。
            *   **阶段3 (域 D₃)**：包含对打印机的访问权。

---

**7.5.2 访问矩阵 (Access Matrix)**

1.  **基本的访问矩阵**
    *   **定义**：用一个矩阵来描述系统中的访问控制关系。
        *   **行 (Row)**：代表**域 (Domain)**。
        *   **列 (Column)**：代表**对象 (Object)**。
        *   **矩阵元素 `Access(i, j)`**：表示在域 Dᵢ 中执行的进程能对对象 Oⱼ 所施加的操作集。
    *   *(参考图 7-18 一个访问矩阵，对应图 7-17 的例子)*
    * ![[Pasted image 20250531144909.png]]
        *   例如 `Access(D₁, F₁)` 为 `{R}`，`Access(D₂, Printer1)` 为 `{W}` (通常打印是写操作)。
    *   **访问权的确定**：访问矩阵中的访问权通常由资源的拥有者或管理者来决定。
        *   创建新对象（如文件）时，创建者成为拥有者，系统在访问矩阵中为新对象增加一列，由拥有者决定该列各域的访问权。
        *   删除对象时，相应列被撤销。

2.  **具有域切换权的访问矩阵**
    *   **目的**：实现进程和域之间的动态联系，允许进程从一个保护域切换到另一个保护域。
    *   **实现**：将**域本身也视为对象**，加入到访问矩阵的列中。
    *   **切换权 (Switch Right)**：当且仅当 `switch ∈ Access(i, j)` 时，才允许在域 Dᵢ 中运行的进程切换到域 Dⱼ。
    * ![[Pasted image 20250531144930.png]]
    *   *(参考图 7-19 具有切换权的访问控制矩阵)*
        *   例如：`Access(D₁, D₂)` 中包含 `S` (Switch)，表示在 D₁ 中运行的进程可以切换到 D₂。
        *   图中 D₁ 可以切换到 D₂，D₂ 可以切换到 D₃，但 D₃ 不能返回到 D₁ (因为 `Access(D₃, D₁)` 中没有 `S`)。

---

**7.5.3 访问矩阵的修改 (Modification of Access Matrix)**

在系统运行过程中，随着用户和需求的变化，需要对访问矩阵进行修改。这可以通过在访问权中引入一些特殊的控制权来实现。

1.  **拷贝权 (Copy Right)**
    *   **目的**：允许将某个域 Dᵢ 对某个对象 Oⱼ 的访问权 `Access(i, j)` 复制（扩展）到同一列的其它域 Dₖ 中，即赋予在 Dₖ 中运行的进程对 Oⱼ 同样的访问权 `Access(k, j)`。
    *   **表示**：在访问权上加星号 `*` (如 `R*`, `W*`) 表示该权限是可拷贝的。
    * ![[Pasted image 20250531144958.png]]
    *   *(参考图 7-20 具有拷贝权的访问控制矩阵)*
        *   **(a) 初始状态**：
            *   D₂ 对 F₂ 有 `R*` (可拷贝的读权限)。
            *   D₁ 对 F₃ 有 `W*` (可拷贝的写权限)。
        *   **(b) 拷贝后**：
            *   D₂ 将其对 F₂ 的 `R*` 权限拷贝给了 D₃，所以 D₃ 对 F₂ 也有了 `R` 权限。
            *   D₁ 将其对 F₃ 的 `W*` 权限拷贝给了 D₃，所以 D₃ 对 F₃ 也有了 `W` 权限。
    *   **限制拷贝 (Limited Copy)**：
        *   当一个带有 `*` 的拷贝权（如 `R*`）从 `Access(i, j)` 拷贝到 `Access(k, j)` 后，新建立的访问权是**不带 `*` 的**（如 `R`）。
        *   这意味着在域 Dₖ 中运行的进程不能再将其获得的这个访问权进一步扩散（拷贝）给其他域。这种方式称为**限制拷贝**，用于控制访问权的扩散范围。

2.  **所有权 (Owner Right)**
    *   **目的**：允许某个域（通常是对象的创建者或管理者）控制对该对象的访问权，即可以增加或删除**其它域**对该对象的访问权。
    *   **表示**：用 `O` 或 `Owner` 表示所有权。
    *   *(参考图 7-21 带所有权的访问矩阵)*
    * * ![[Pasted image 20250531145019.png]]
        *   **(a) 初始状态**：
            *   D₁ 是 F₁ 的所有者 (`O, E`)。
            *   D₂ 是 F₂ (`R', O`) 和 F₃ (`R', O, W`) 的所有者。
        *   **(b) 修改后**：
            *   D₁ 作为 F₁ 的所有者，删除了 D₃ 对 F₁ 的执行权 `E` (假设 D₃ 原来有 E)。
            *   D₂ 作为 F₂ 和 F₃ 的所有者，增加了 D₃ 对 F₂ 和 F₃ 的写权限 `W`。

3.  **控制权 (Control Right)**
    *   **目的**：允许某个域 Dᵢ 控制另一个域 Dⱼ **内部**的各项访问权，即修改 `Access(j, k)` (对于所有对象 k)。
    *   **作用**：用于改变在某个特定域 Dⱼ 中运行的进程对**不同对象**的访问权。
     ![[Pasted image 20250531145059.png]]
    *   *(参考图 7-22 具有控制权的访问矩阵)*
        *   `Access(D₂, D₃)` 中包含 `Control` 权。
        *   这意味着在域 D₂ 中运行的进程可以修改域 D₃ 对所有对象的访问权。
        *   比较图 7-19 和图 7-22：在 D₃ 中，原来对 F₆ 和 Plotter2 有写权限，现在这些写权限被域 D₂ (通过控制权) 删除了。

---

**7.5.4 访问矩阵的实现 (Implementation of Access Matrix)**

直接实现访问矩阵在概念上简单，但实际中存在困难：

*   **规模庞大**：在稍具规模的系统中，域和对象的数量都可能很大（例如，100个域，10⁵个对象，矩阵将有 10⁷ 个表项）。
*   **存储开销大**：即使每个表项只占一个字节，也需要大量存储空间（如 100MB）。
*   **访问费时**：对如此大的矩阵进行访问和查找效率低下。
*   **稀疏性**：访问矩阵通常是**稀疏矩阵**，即绝大多数项为空（表示没有权限），存储所有空项是浪费的。

**常用的实现方法 (将矩阵按行或按列划分)：**

1.  **访问控制表 (Access Control List - ACL)**
    *   **按列 (对象) 划分**：为每一个对象建立一张访问控制表 (ACL)。
    *   **ACL 的内容**：记录了哪些域（或用户/进程）可以对该对象执行哪些操作。ACL 由一系列有序对 `(域, 权集)` 组成。
    *   **存储**：ACL 通常存放在该文件的文件控制块 (FCB) 中，或文件的索引结点中，作为该文件的存取控制信息。
    *   **优点**：
        *   只存储非空权限项，显著减少存储空间。
        *   提高查找速度（相对于整个矩阵）。
    *   **实现方式举例 (域即用户)**：
        *   当用户尝试访问文件时，系统检查该文件的 ACL，看该用户是否在列表中以及拥有何种权限。
    *   **缺省访问权集**：可以为对象定义一个缺省的访问权集，当某个用户/进程不在 ACL 中明确列出时，使用缺省权限。

2.  **访问权限表 (Capability List - C-List)**
    *   **按行 (域) 划分**：为每一个域构成一张访问权限表。
    *   **C-List 的内容**：记录了该域对系统中各个对象所拥有的访问权。表中的每一项代表该域对某个对象的访问权限。
    *   **结构**：通常包含 `(类型, 权力, 对象指针)`。
        *   **类型**：对象类型（如文件、打印机）。
        *   **权力**：该域对该对象拥有的访问权集。
        *   **对象指针**：指向相应对象的标识（如UNIX中的i-node号）。
    *   *(参考图 7-23 访问权限表，对应图 7-19 中域 D₂ 的权限)*
    * ![[Pasted image 20250531145127.png]]
        *   域 D₂ 可以访问：文件3 (只读)，文件4 (读写执行)，文件5 (读写)，打印机1 (写)。
    *   **安全性要求**：访问权限表本身必须受到保护，不能被用户直接访问或修改。通常存储在操作系统的专用区域内，只有通过合法性检查的程序才能访问。
    *   **使用流程 (简例)**：
        1.  进程第一次试图访问某对象时，系统检查其所在域的 C-List，验证是否有权访问。
        2.  如果无权，则拒绝访问并产生异常。
        3.  如果有权，则允许访问，并可能为该进程建立一个临时的、更快速的访问凭证（“权能”），供后续访问使用。
        4.  当进程不再需要访问该对象时，撤销该临时凭证。

**结合使用 ACL 和 C-List：**
许多系统同时采用这两种机制。例如，为每个对象配置 ACL。当进程首次访问对象时，系统检查 ACL。若有权，则为该进程（或其域）创建一个 Capability (权限)，并加入到其 C-List 中。后续访问可直接通过 C-List 快速验证。

---