



* 8.1 **外存的组织方式**

	**核心概念：** 文件的物理结构直接关联于外存（如磁盘）的组织方式。不同的外存组织方式会导致不同的文件物理结构。
	* **主要外存组织方式分类**：
		1.  **连续组织方式 (Continuous Organization):** 文件数据存储在连续的磁盘块中。
		    *   形成的文件物理结构：**顺序式文件结构** (或称顺序文件)。
		2.  **链接组织方式 (Linked Organization):** 文件数据存储在不连续的磁盘块中，通过指针链接。
		    *   形成的文件物理结构：**链接式文件结构** (或称链接文件)。
		3.  **索引组织方式 (Indexed Organization):** 文件数据存储在不连续的磁盘块中，通过一个或多个索引块来定位数据块。
		    *   形成的文件物理结构：**索引式文件结构** (或称索引文件)。

	* ***操作系统演进：**
		*   传统文件系统：通常只采用一种组织方式。
		*   现代操作系统 (OS)：由于存在多种类型文件（尤其是实时多媒体文件），可能对不同文件采用多种类型的组织形式。

---

**8.1.1 连续组织方式 (Continuous Organization)**

*   **别名：** 连续分配方式 (Continuous Allocation)。
*   **定义：** 为每个文件分配一组**相邻接**的盘块。
    *   例如：若第一个盘块地址为 `b`，则后续盘块地址为 `b+1`, `b+2`, ...
    *   通常这些盘块位于同一磁道，以减少读写时磁头的移动。
*   **文件结构：** 逻辑文件中的记录顺序地存储到邻接的各物理盘块中，形成**顺序文件结构**。此时的物理文件称为**顺序文件**。
*   **特性：** 保证逻辑文件中记录顺序与存储器中文件占用盘块的顺序一致。
*   **目录项记录：** 在目录项的“文件物理地址”字段中记录文件的**第一个记录所在的盘块号**和**文件长度** (以盘块为单位)。
    *   *图8-1 示例：* `count` 文件起始盘块号0，长度2盘块，存放在盘块0和1。
	    * ![[Pasted image 20250531145444.png]]
*   **优点：**
    1.  **顺序访问容易：** 系统从目录中找到文件首盘块号，然后逐个盘块读/写。
    2.  **支持定长记录的随机存取：** 可以通过计算直接定位到记录所在的盘块和块内偏移。
    3.  **顺序访问速度快：** 因盘块连续（可能在同磁道或相邻磁道），磁头移动距离最短，访问速度是几种方式中最高的。
*   **缺点：**
    1.  **产生外部碎片：** 类似内存的动态分区分配，多次创建和删除文件后，磁盘空间被分割成许多小连续区，难以利用。通过“紧凑”消除碎片耗时巨大。
    2.  **必须事先知道文件长度：** 分配连续空间前需确定文件大小。
        *   若估计过小：存储空间不足导致拷贝中止，需用户重新估算。
        *   若估计过大：用户倾向于估大文件长度，造成空间浪费。
    3.  **不能灵活地删除和插入记录：** 为保持文件有序性，删除/插入记录需物理移动相邻记录，并可能动态改变文件大小。
    4.  **不适用于动态增长的文件：** 难以预知最终大小，预分配过多则长期空闲浪费空间。

---
**8.1.2 链接组织方式 (Linked Organization)**
*   **核心思想：** 允许文件装入多个**离散的盘块**中，通过每个盘块上的链接指针将属于同一文件的盘块链接成一个链表。
*   **文件结构：** 物理文件称为**链接文件**。
*   **优点：**
    1.  **消除外部碎片：** 提高了外存利用率。
    2.  **记录插入、删除、修改容易。**
    3.  **适应文件动态增长：** 无需事先知道文件大小。
*   **链接方式分类：**
    1.  **隐式链接 (Implicit Linking)**
    2.  **显式链接 (Explicit Linking)**

    **1. 隐式链接 (Implicit Linking)**
    *   **目录项记录：** 包含指向链接文件**第一个盘块**和**最后一个盘块**的指针。
    *   **盘块结构：** 每个盘块中除了数据外，还包含一个指向**下一个盘块**的指针。
        *   *图8-2 示例：* `jeep` 文件，首盘块9，尾盘块25。盘块9指向盘块16，盘块16指向盘块1...
	        * ![[Pasted image 20250531145524.png]]
        *   指针占用空间：若指针占4字节，盘块大小512字节，则用户可用508字节。
    *   **主要问题/缺点：**
        *   **只适合顺序访问：** 随机访问效率极低 (访问第 `i` 块需从头读 `i-1` 次盘)。
        *   **可靠性较差：** 任何一个指针损坏都会导致整个链断开。
    *   **改进尝试：簇 (Cluster)**
        *   将几个盘块组成一个簇。分配和链接以簇为单位。
        *   优点：成倍减少查找时间，减少指针占用空间。
        *   缺点：增大了内部碎片。改进有限。

    ---
    **2. 显式链接 (Explicit Linking)**
    *   **核心思想：** 把用于链接文件各物理块的指针，显式地存放在内存的一张**链接表 (File Allocation Table - FAT)** 中。
    *   **FAT表结构：**
        *   整个磁盘仅设置一张FAT表。
        *   表的序号是物理盘块号 (从0到N-1，N为盘块总数)。
        *   每个表项存放对应盘块的**下一个链接盘块的盘块号**。
        *   文件末尾的盘块号在FAT表对应条目中用特殊标记（如-1）表示。
    *   **目录项 (FCB) 记录：** 文件地址（即文件的**第一个盘块号**）填入FCB的“物理地址”字段。
    *   **优点：**
        *   查找记录过程在内存中进行（查FAT表），显著提高检索速度。
        *   大大减少访问磁盘次数。
    *   *图8-3 示例：* FCB中记录文件起始块为2，$FAT[2]为4，FAT[4]为5，FAT[5]为-1$ (文件结束)。
	    * ![[Pasted image 20250531145605.png]]

---

**8.1.3 FAT 技术 (File Allocation Table Technology)**

*   **背景：** 微软早期操作系统（MS-DOS, Windows 9x）采用的技术，利用文件分配表(FAT)记录文件中所有盘块间的链接。
*   **演进：** FAT12 -> FAT16 -> FAT32。后续Windows NT/2000/XP等发展了NTFS。
*   **“卷” (Volume/分区) 概念：**
    *   物理磁盘可分多个逻辑磁盘（卷/分区）。
    *   每个卷可被单独格式化和使用，包含文件系统信息、文件、空闲空间。
    *   每个卷有自己的目录、FAT表、逻辑驱动器号 (C:, D:等)。
*   **FAT表冗余：** 通常每个分区有两个相同的FAT表 (FAT1和FAT2) 以确保安全。

    ---
    **1. FAT12**
    *   **早期FAT12系统 (以盘块为分配单位)：**
        *   FCB存文件首盘块号。FAT表项12位。
        *   1.2MB软盘：盘块大小512B，FAT表共2.4K表项 (2^12 ≈ 4K，实际可用4096个)，FAT表占3.6KB。
        *   最大磁盘容量：
            *   每个分区：4096表项 * 512B/盘块 = 2MB。
            *   物理磁盘 (支持4个分区)：2MB * 4 = 8MB。
    *   **FAT12系统 (以簇为分配单位)：**
	    * ![[Pasted image 20250531145657.png]]
        *   为支持更大硬盘，引入**簇 (Cluster)** 作为分配单位。簇是一组相邻的扇区（盘块）。
        *   簇大小：一般为2^n个盘块 (如1KB, 2KB, 4KB)。
        *   好处：
            *   适应磁盘容量增大。
            *   减少FAT表项数 (相同容量下，簇越大，表项越少)。
            *   减少访问FAT表的开销。
        *   坏处：**簇内零头 (内部碎片)** 增大。
        *   最大磁盘容量 (簇为单位)：
            *   若1簇=1扇区(512B)：最大分区2MB，磁盘8MB。
            *   若1簇=8扇区(4KB)：最大分区16MB，磁盘64MB (根据书中上下文推算，4096簇 * 4KB/簇 = 16MB/分区，*4分区=64MB)。
        *   主要问题：簇内碎片随容量增加而成倍增加，限制了磁盘最大容量（通常数十MB）。仅支持短文件名 (8+3格式)。

    ---
    **2. FAT16**
    *   **原因：** FAT12表项数有限 (4096个)。
    *   **改进：** FAT表项增至16位。
    *   **最大表项数：** 2^16 = 65536个。一个分区可分为65536个簇。
    *   **簇中盘块数：** 4, 8, ..., 64个。
    *   **最大分区空间：** 2^16簇 * 64盘块/簇 * 512B/盘块 = 2048MB (2GB)。
    *   **问题：** 磁盘容量迅速增加时，为支持大分区，簇的容量必须很大，簇内碎片浪费严重 (如8GB分区，簇大小128KB，内部零头最大128KB。1GB~4GB硬盘浪费10%~20%)。
    ---
    **3. FAT32**
	    ![[Pasted image 20250531145731.png]]
    *   **原因：** FAT16簇内零头问题。
    *   **改进：** FAT表项宽度增加，允许更多簇，从而可以使用更小的簇。
        *   每个簇在FAT表项中占4字节 (32位)，实际使用28位表示簇号 (2^28个簇)。
        *   FAT32每个簇固定为4KB (即8个盘块)。 (注：实际簇大小可配置，但4KB是常见值)
        *   *图8-5 FAT中簇的大小与最大分区的对应关系* 表格说明了不同FAT类型支持的簇大小和分区大小。
    *   **最大分区空间：** 4KB/簇 * 2^28簇 ≈ 1TB (理论可达2TB，但受限于其他因素)。
    *   **优点：**
        *   支持更小的簇，存储利用率更高 (比FAT16提高约15%)。
        *   支持长文件名。
        *   有效节省硬盘空间。
    *   **缺点：**
        *   文件分配表扩大，运行速度比FAT16慢。
        *   有最小管理空间限制 (FAT32卷至少需65537个簇，不支持<512MB的小分区，这些小分区仍用FAT16/12)。
        *   单个文件长度不能大于4GB。
        *   兼容性方面，不能保持向下兼容。

---
**8.1.4 NTFS 的文件组织方式 (New Technology File System)**

*   **背景：** 专门为Windows NT开发，适用于Windows 2000/XP及后续Windows OS。
*   **新特征：**
    1.  **64位磁盘地址。**
    2.  **支持长文件名：** 单个文件名最多255字符，全路径名32767字符。
    3.  **系统容错功能：** 系统故障或差错时，能保证系统正常运行。
    4.  **数据一致性保证。**
    5.  **文件加密、文件压缩等功能。**
*   **磁盘组织：**
    *   **簇 (Cluster)：** 磁盘空间分配和回收的基本单位。文件占用若干簇，一个簇只属于一个文件。簇大小与物理块大小无关。
    *   **卷因子 (Volume Factor)：** 即簇的大小，磁盘格式化时确定，是物理磁盘扇区的整数倍 (512B, 1KB, ..., 最大64KB)。
        *   默认簇大小：≤512MB磁盘为512字节，1GB磁盘为1KB，2GB磁盘为4KB。通常为4KB。
    *   **簇的定位：**
        *   **LCN (Logical Cluster Number - 逻辑簇号)：** 以卷为单位，将卷中所有簇按序编号。
        *   **VCN (Virtual Cluster Number - 虚拟簇号)：** 以文件为单位，将属于某文件的簇按序编号。
        *   地址映射：VCN -> LCN。物理字节偏移量 = LCN * 卷因子。
*   **文件的组织：主控文件表 (Master File Table - MFT)**
    *   **MFT：** NTFS卷结构的中心。以文件记录方式记录卷中所有文件信息、目录信息、可用未分配空间信息。MFT本身也是一个文件。
    *   **元数据 (Metadata)：** MFT中每行对应一个文件，称为该文件的元数据，大小固定为1KB。也称文件控制字。
    *   **属性 (Attribute)：** 每个元数据将其对应文件的所有信息（包括文件内容）组织成一组属性。
    *   **小文件存储：** 文件较小时，其属性值（如文件内容DATA）直接记录在MFT的元数据中（称为**常驻属性 Resident Attribute**）。减少磁盘访问，提高小文件存取效率。
    *   **大文件存储：** 文件较大时，元数据仅记录部分属性，其余属性（如文件内容）记录到卷中其他可用簇中。这些簇按其记录的文件属性分类，链接成多个**区段 (Run/Extent)**，指向这些区段的指针保存在元数据中 (称为**非常驻属性 Non-resident Attribute**)。
        *   NTFS倾向于将数据连续存放在若干相邻簇中（一个区段）。
        *   一个文件可以由多个不连续的区段组成。
*   **NTFS的不足之处：**
    *   只能被Windows NT系列系统识别。
    *   NTFS文件不能被FAT等文件系统存取，缺乏兼容性 (Windows 95/98/Me不能识别NTFS)。

---
**8.1.5 索引组织方式 (Indexed Organization)**

*   **动机：** 解决链接组织方式（特别是FAT）存在的问题：
    1.  对较大文件进行直接存取时，效率不高 (需在FAT中顺序查找多个盘块号)。
    2.  FAT需占用较大内存空间 (整个FAT需调入内存)。
*   **核心思想：** 为每个文件分配一个**索引块 (表)**，把分配给该文件的所有盘块号都记录在该索引块中。
*   **目录项记录：** 填上指向该文件**索引块的指针**。

    ---
    **1. 单级索引组织方式 (Single-level Index Organization)**
	    
    *   *图8-6 示例：* `jeep` 文件的目录项指向索引块19。索引块19中存放了文件数据实际占用的盘块号列表：9, 16, 1, 10, 25, ... (末尾用-1表示结束)。
	    * ![[Pasted image 20250531145821.png]]
    *   **优点：**
        *   **支持直接访问：** 读第 `i` 盘块时，可直接从索引块中找到第 `i` 个盘块号。
        *   **不产生外部碎片。**
        *   比链接分配方式更优（尤其对大文件）。
    *   **缺点：**
        *   **索引块开销：** 每个文件（即使很小，只占几块）都需要一个索引块，索引块利用率可能很低。

    ---
    **2. 多级索引组织方式 (Multi-level Index Organization)**
    *   **动机：** 大文件分配的盘块号过多，一个索引块装不下。若将多个索引块链接起来，效率低。
    *   **核心思想：** 为索引块再建立索引。
    *   **两级索引 (图8-7)：**
	    * ![[Pasted image 20250531145845.png]]
        *   第一级索引块（主索引块）存放第二级索引块的地址。
        *   第二级索引块存放实际数据盘块的地址。
    *   **文件大小示例 (假设盘块大小1KB，盘块号占4字节，则一个索引块可存256个盘块号)：**
        *   单级索引：最大文件 256 * 1KB = 256KB。 (若盘块4KB，则为 256*4KB = 1MB；若索引项1024个，则为1024*4KB=4MB)
        *   两级索引：最大文件 256 * 256 * 1KB = 64MB。 (若盘块4KB，索引项1024个，则为 1024*1024*4KB = 4GB)
    *   **优点：** 大大加快对大型文件的查找速度。
    *   **缺点：** 访问一个盘块时，所需启动磁盘次数随索引级数增加而增多，即使对小文件也如此。而系统中通常中小文件居多。

    ---
    **3. 增量式索引组织方式 (Incremental Indexed Organization)**
	    ![[Pasted image 20250531145911.png]]
    *   **别名：** 混合组织方式 (Hybrid Organization)，如UNIX系统采用。
    *   **基本思想：** 结合直接寻址、单级索引、多级索引，以全面照顾小、中、大及特大型文件的访问需求。
    *   **UNIX System V 的组织方式 (i-node 索引结点)：**
        *   索引结点 (i-node) 中设有13个地址项 `i.addr(0)` ~ `i.addr(12)` (如图8-8)。
        *   **(1) 直接地址 (Direct Blocks)：** `i.addr(0)` ~ `i.addr(9)` (共10项) 直接存放文件数据所在盘块的盘块号。
            *   若盘块4KB，文件不大于 40KB (10 * 4KB) 时，可直接从i-node读出全部盘块号。
        *   **(2) 一次间接地址 (Single Indirect)：** `i.addr(10)` 指向一个一次间址块 (索引块)。该块中存放数据盘块号。
            *   若一个间址块可存1K个盘块号 (如4KB盘块/4字节地址 = 1024个地址)，则此部分支持文件大小 1K * 4KB = 4MB。
        *   **(3) 二次间接地址 (Double Indirect)：** `i.addr(11)` 指向一个二次间址块。该块中存放一次间址块的地址。
            *   支持文件大小 1K * 1K * 4KB = 4GB。
        *   **(4) 三次间接地址 (Triple Indirect)：** `i.addr(12)` 指向一个三次间址块。
            *   支持文件大小 1K * 1K * 1K * 4KB = 4TB。
    *   **优点：**
        *   小文件访问快（直接地址）。
        *   支持非常大的文件。
        *   兼顾了不同大小文件的访问效率。

---
