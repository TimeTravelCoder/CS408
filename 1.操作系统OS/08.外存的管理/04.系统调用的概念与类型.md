
**引言：**
系统调用是操作系统为用户程序提供服务的一种接口。它不仅可供应用程序使用，也可供操作系统自身使用。每个操作系统通常都有大量系统调用，根据功能可划分为若干类别，每个系统调用都是一个能完成特定功能的子程序。

---

**9.4.1 系统调用的基本概念**

1.  **系统态和用户态 (核心态和目态)**
    *   **目的：** 为了防止应用程序对操作系统的破坏，计算机系统通常设置两种运行状态：
        *   **系统态 (System Mode / Kernel Mode / 核心态)：** 操作系统内核运行在此状态，对内存空间访问基本不受限制，能访问用户空间和系统空间。
        *   **用户态 (User Mode / 目态)：** 应用程序运行在此状态，访问范围受限，只能完成一般性操作和任务。
    *   **指令集划分：**
        *   **特权指令 (Privileged Instructions)：** 只能在系统态运行。例如：启动外部设备、设置系统时钟、关中断、转换执行状态等。这些指令只允许操作系统使用，以避免应用程序引起系统混乱。
        *   **非特权指令 (Non-Privileged Instructions)：** 可以在用户态运行。应用程序使用的都是非特权指令，不能直接访问硬件和软件资源，内存访问也局限于用户空间。
    *   **限制机制：** 这种限制由硬件实现。若应用程序试图使用特权指令，会发出权限出错信号，操作系统捕获后会停止该程序运行并重新调度。

2.  **系统调用 (System Call)**
	1. ![[Pasted image 20250531150339.png]]
    *   **目的：** 使应用程序能通过它间接调用操作系统中的相关过程，以获得操作系统提供的服务。
    *   **本质：** 应用程序请求操作系统内核完成某功能时的一种过程调用，但它是特殊的过程调用。
    *   **与一般过程调用的区别：**
        *   **运行状态不同：**
            *   一般过程调用：调用程序和被调用程序运行在相同状态（都是系统态或都是用户态）。
            *   系统调用：调用程序运行在用户态，被调用程序（内核代码）运行在系统态。
        *   **状态转换：**
            *   一般过程调用：不涉及系统状态转换，可直接由调用过程转向被调用过程。
            *   系统调用：涉及从用户态到系统态的转换，需要通过软中断机制（陷阱指令），经内核分析后才能转向相应的系统调用处理子程序。
        *   **返回问题（在抢占式调度系统中）：**
            *   一般过程调用：执行完后直接返回调用点。
            *   系统调用：完成后，系统会对所有要求运行的进程做优先级分析。若调用进程仍具最高优先级，则返回；否则，将引起重新调度，调用进程进入就绪队列。
        *   **嵌套调用：**
            *   一般过程调用：嵌套深度无严格限制。
            *   系统调用：也可以嵌套调用（一个系统调用中调用另一个系统调用），但通常有深度限制（例如，最大深度为6）。
    *   **示例（文件拷贝程序）：**
        1.  输入源文件名和目标文件名（一系列控制台I/O相关的系统调用）。
        2.  通过`open`系统调用打开输入文件，`creat`系统调用创建输出文件（可能出错，需要错误处理系统调用）。
        3.  通过`alloc`系统调用申请内存缓冲区。
        4.  通过`read`系统调用从输入文件读数据到缓冲区。
        5.  通过`close`系统调用关闭输入文件。
        6.  通过`write`系统调用将缓冲区数据写入输出文件。
        7.  （循环读写，期间可能发生错误，如文件末尾、硬件故障、磁盘满等，需要错误处理）。
        8.  通过`close`系统调用关闭输出文件。
        9.  通过`exit`系统调用使程序正常结束。
        *   **结论：** 一个用户程序会频繁利用系统调用来取得操作系统提供的多种服务。

4.  **中断机制 (Interrupt Mechanism)**
    *   **实现方式：** 系统调用是通过中断机制实现的。一个操作系统的所有系统调用通常通过同一个中断入口来实现。
    *   **示例：** MS-DOS 提供 `INT 21H`，应用程序通过此中断获取操作系统服务。
    *   **保护机制：** 在有保护机制的操作系统中，中断机制本身也是受保护的。
        *   例如，在 IBM PC 上，Intel 提供了多达255个中断号，但只有授权给应用程序保护等级的中断号才能被应用程序调用。
        *   Linux 仅给应用程序授权了4个中断号：3, 4, 5 (用于调试) 和 80h (用于系统调用)。
        *   若应用程序调用未被授权的中断号，会引起保护异常，导致程序被操作系统停止。

---

**9.4.2 系统调用的类型**

通用操作系统提供的系统调用虽有差异，但大体可分为以下几类：

1.  **进程控制类系统调用**
    *   **创建和终止进程：** 如 `fork` (创建), `exit` (终止)。
    *   **获得和设置进程属性：** 如获取进程标识符 (PID)、进程优先级、最大允许执行时间等。
    *   **等待某事件出现：** 进程运行时，可能需要等待某事件（条件）出现后方可继续执行，此时可利用等待事件的系统调用使自己处于等待状态，事件发生后被唤醒。

2.  **文件操纵类系统调用**
    *   **创建和删除文件：** 请求系统创建新文件或删除指定文件。
    *   **打开和关闭文件：** 用户首次访问文件前需打开，访问结束后关闭。
    *   **读和写文件：** 从已打开的文件中读出数据或向文件中写入数据（这是文件操纵类中使用最频繁的）。

3.  **进程通信类系统调用**
    *   **消息传递方式：**
        1.  源进程发出“打开连接”的系统调用。
        2.  目标进程利用“接受连接”的系统调用表示同意通信。
        3.  之后，可通过“发送消息”和“接收消息”的系统调用交换信息。
        4.  通信结束后，通过“关闭连接”的系统调用结束通信。
    *   **共享存储区方式：**
        1.  利用“建立共享存储区”的系统调用建立共享区。
        2.  利用“建立连接”的系统调用将该共享区连接到进程自身的虚地址空间。
        3.  之后，利用读写共享区的系统调用实现通信。

4.  **其他常用系统调用**
    *   **设备管理类：** 申请设备、释放设备、设备I/O、重定向、获得和设置设备属性等。
    *   **信息维护类：** 获得系统和文件的时间/日期、操作系统版本、当前用户、空闲内存和磁盘空间大小等。

---

**9.4.3 POSIX 标准**

*   **背景：** 不同操作系统提供的系统调用在实现细节和形式上相差很大，给应用程序的平台无关性带来困难。
*   **POSIX (Portable Operating System IX)：** 国际标准化组织 (ISO) 提出的有关系统调用的国际标准，如 POSIX 1003.1，称为“基于UNIX的可移植操作系统接口”。
*   **目的：** 定义标准应用程序接口 (API)，保证编制的应用程序可以在源代码一级在多种操作系统上移植运行。
*   **POSIX 与系统调用的关系：**
    *   POSIX 标准定义了一组**过程 (procedures)**，这些过程是构造系统调用所必须的，通过调用这些过程提供的服务来确定一系列系统调用的功能。
    *   一般而言，一个 POSIX 过程直接映射一个系统调用。
    *   有时，一个系统调用可能对应若干个 POSIX 过程（例如，当一个系统调用所需的过程是其他系统调用的组合或变形时）。
*   **实现形式：**
    *   POSIX 标准定义了过程的功能，但**未明确规定系统调用的实现形式**（是库函数还是其他形式）。
    *   **早期 OS：** 系统调用用汇编语言编写，可看作扩展的机器指令，汇编程序可直接使用。
    *   **现代 OS (如 UNIX 新版, Linux, Windows, OS/2)：** 系统调用用 C 语言编写，并以**库函数 (library function)** 形式提供。C 语言编制的应用程序可直接使用对应的库函数来使用系统调用。库函数的目的是隐藏访管指令（陷阱指令）的细节，使系统调用更像过程调用。
*   **层次关系 (如图 9-7 所示)：**
	* ![[Pasted image 20250531150429.png]]
    *   用户程序 (User Program)
    *   标准系统程序/实用程序 (Standard System Programs: assembler, compiler, editor, Shell)
    *   标准库函数 (Standard Library Functions: open, close, read, write, create, delete)
    *   操作系统 (Operating System - System Calls: process management, memory management, file management, device management)
    *   硬件 (Hardware)
    *   **注意：** 一般来说，库函数属于用户程序，而非系统调用程序。

---

