好的，这是重新排版后的内容，力求体现层级结构，内容保持不变：

---

**6.1 I/O 系统的功能、模型和接口**

I/O 系统管理的主要对象是 I/O 设备和相应的设备控制器。
其最主要的任务是：
1.  完成用户提出的 I/O 请求。
2.  提高 I/O 速率。
3.  提高设备的利用率。
4.  能为更高层的进程方便地使用这些设备提供手段。

---

**6.1.1 I/O 系统的基本功能**

为了满足系统和用户的要求，I/O 系统应具有下述几方面的基本功能：
*   **第一、二方面功能**：为了方便用户使用 I/O 设备。
*   **第三、四方面功能**：用于提高 CPU 和 I/O 设备的利用率。
*   **第五、六方面功能**：为用户在共享设备时提供方便，以保证系统能有条不紊的运行，当系统发生错误时能及时发现错误，甚至于能自动修正错误。

1.  **隐藏物理设备的细节**
    *   **背景**：I/O 设备的类型非常多，彼此间在多方面都有差异，例如：
        *   接收和产生数据的速度
        *   传输方向
        *   粒度
        *   数据的表示形式
        *   可靠性
    *   **控制方式**：为这些千差万别的设备配置相应的设备控制器（一种硬件设备），其中包含：
        *   若干个用于存放控制命令的寄存器。
        *   若干个用于存放参数的寄存器。
        *   用户通过这些命令和参数，可以控制外部设备执行所要求的操作。
    *   **问题**：不同的设备需要不同的命令和参数。
        *   例如：对磁盘操作时，不仅要给出读/写命令，还需给出源或目标数据的位置（磁盘的盘面号、磁道号和扇区号）。
        *   如果要求程序员或用户编写直接面向这些设备的程序，是极端困难的。
    *   **解决方案**：I/O 系统必须通过对设备加以适当的抽象，以隐藏掉物理设备的实现细节，仅向上层进程提供少量的、抽象的读/写命令，如 `read`、`write` 等。

2.  **与设备的无关性**
    *   **实现时机**：在较晚时才实现，是在隐藏物理设备细节的基础上实现的。
    *   **具体表现**：
        *   **对用户而言**：
            *   不仅可以使用抽象的 I/O 命令。
            *   还可使用抽象的逻辑设备名来使用设备。例如，用户输出打印时，只需提供读(或写)的命令和抽象的逻辑设备名（如 `/dev/printer`），而不必指明是哪一台打印机。
        *   **对 OS 本身而言**：
            *   有效地提高 OS 的可移植性和易适应性。
            *   允许在不需要将整个操作系统进行重新编译的情况下，增添新的设备驱动程序，以方便新的 I/O 设备的安装。
            *   例如：Windows 中，系统可以为新 I/O 设备自动安装和寻找驱动程序，从而做到即插即用。

3.  **提高处理机和 I/O 设备的利用率**
    *   **基础**：在一般的系统中，许多 I/O 设备间是相互独立的，能够并行操作；在处理机与设备之间也能并行操作。
    *   **I/O 系统的目标**：尽可能地让处理机和 I/O 设备并行操作，以提高它们的利用率。
    *   **实现途径**：
        *   一方面要求处理机能快速响应用户的 I/O 请求，使 I/O 设备尽快地运行起来。
        *   另一方面也应尽量减少在每个 I/O 设备运行时处理机的干预时间。

4.  **对 I/O 设备进行控制**
    *   **执行者**：驱动程序的功能。
    *   **控制方式 (目前有四种)**：
        *   ① 采用轮询的可编程 I/O 方式。
        *   ② 采用中断的可编程 I/O 方式。
        *   ③ 直接存储器访问 (DMA) 方式。
        *   ④ I/O 通道方式。
    *   **选择依据**：与 I/O 设备的传输速率、传输的数据单位等因素有关。
        *   **低速设备** (如打印机、键盘终端)：其传输数据的基本单位是字节(或字)，故应采用中断的可编程 I/O 方式。
        *   **高速设备** (如磁盘、光盘)：其传输数据的基本单位是数据块，故应采用直接存储器访问方式，以提高系统的利用率。
        *   **I/O 通道方式**：使对 I/O 操作的组织和数据的传输，都能独立进行而无需 CPU 的干预。
    *   **I/O 软件的目标**：为方便高层软件和用户，I/O 软件应屏蔽掉这种差异，向高层软件提供统一的操作接口。

5.  **确保对设备的正确共享**
    *   **设备分类 (从共享属性上)**：
        *   **(1) 独占设备**：进程应互斥地访问这类设备，即系统一旦把这类设备分配给了某进程后，便由该进程独占，直至用完释放。典型的独占设备有打印机、磁带机等。系统在对独占设备进行分配时，还应考虑到分配的安全性。
        *   **(2) 共享设备**：指在一段时间内允许多个进程同时访问的设备。典型的共享设备是磁盘。当有多个进程需对磁盘执行读、写操作时，可以交叉进行，不会影响到读、写的正确性。

6.  **错误处理**
    *   **原因**：大多数设备都包括了较多的机械和电气部分，运行时容易出现错误和故障。
    *   **错误分类 (从处理角度)**：
        *   **临时性错误**：可通过重试操作来纠正。
        *   **持久性错误**：只有在发生了持久性错误时，才需要向上层报告。
    *   **处理示例**：磁盘传输过程中发生错误，系统并不认为磁盘已发生故障，而是可以重新再传，一直要重传多次后，若仍有错，才认为磁盘发生了故障。
    *   **处理原则**：由于多数错误是与设备紧密相关的，因此对于错误的处理，应该尽可能在接近硬件的层面上进行，即在低层软件能够解决的错误就不向上层报告，因此高层也就不能感知；只有低层软件解决不了的错误才向上层报告，请求高层软件解决。

---

**6.1.2 I/O 系统的层次结构和模型**

*   **背景**：I/O 软件涉及的面很宽，向下与硬件有密切关系，向上又与文件系统、虚拟存储器系统和用户直接交互，它们都需要 I/O 系统来实现 I/O 操作。
*   **目的**：为使十分复杂的 I/O 软件能具有清晰的结构、更好的可移植性和易适应性。
*   **方法**：目前已普遍采用层次式结构的 I/O 系统。这是将系统中的设备管理模块分为若干个层次，每一层都是利用其下层提供的服务，完成输入输出功能中的某些子功能，并屏蔽这些功能实现的细节，向高层提供服务。

1.  **I/O 软件的层次结构 (如图 6-1)**
    ![[Pasted image 20250531135848.png]]
    *   通常把 I/O 软件组织成四个层次，图中的箭头表示 I/O 的控制流。
    *   各层次及其功能：
        *   **(1) 用户层 I/O 软件**：实现与用户交互的接口，用户可直接调用该层所提供的、与 I/O 操作有关的库函数对设备进行操作。
            *   *对应图示活动：产生 I/O 请求、格式化 I/O、Spooling*
        *   **(2) 设备独立性软件**：用于实现用户程序与设备驱动器的统一接口、设备命名、设备的保护以及设备的分配与释放等，同时为设备管理和数据传送提供必要的存储空间。
            *   *对应图示活动：映射、保护、分块、缓冲、分配*
        *   **(3) 设备驱动程序**：与硬件直接相关，用于具体实现系统对设备发出的操作指令，驱动 I/O 设备工作的驱动程序。
            *   *对应图示活动：设置设备寄存器；检查状态*
        *   **(4) 中断处理程序**：用于保存被中断进程的 CPU 环境，转入相应的中断处理程序进行处理，处理完毕再恢复被中断进程的现场后，返回到被中断的进程。
            *   *对应图示活动：I/O 应答*
        *   **硬件层**：执行具体的 I/O 操作。

2.  **I/O 系统中各种模块之间的层次视图 (如图 6-2)**
    ![[Pasted image 20250531135930.png]]
    *   **1) I/O 系统的上、下接口**
        *   **(1) I/O 系统接口**：它是 I/O 系统与上层系统之间的接口，向上层提供对设备进行操作的抽象 I/O 命令，以方便高层对设备的使用。不少 OS 在用户层提供了与 I/O 操作有关的库函数，供用户使用。在上层系统中有文件系统、虚拟存储器系统以及用户进程等。
        *   **(2) 软件/硬件 (RW/HW) 接口**：下面一个接口是软件/硬件接口，在它的上面是中断处理程序和用于不同设备的设备驱动程序。在它的下面是各种设备的控制器，如 CD-ROM 控制器、硬盘控制器、键盘控制器、打印机控制器、网络控制器等，它们都属于硬件。由于设备种类繁多，故该接口相当复杂。
        *   *在上、下两个接口之间则是 I/O 系统。*
    *   **2) I/O 系统的分层**
        *   与前面所述的 I/O 软件组织的层次结构相对应，I/O 系统本身也可分为如下三个层次：
            *   **(1) 中断处理程序**：它处于 I/O 系统的底层，直接与硬件进行交互。当有 I/O 设备发来中断请求信号时，在中断硬件做了初步处理后，便转向中断处理程序。它首先保存被中断进程的 CPU 环境，然后转入相应设备的中断处理程序进行处理，在处理完成后，又恢复被中断进程的 CPU 环境，返回断点继续运行。
            *   **(2) 设备驱动程序**：它处于 I/O 系统的次底层，是进程和设备控制器之间的通信程序。其主要功能是，将上层发来的抽象 I/O 请求转换为对 I/O 设备的具体命令和参数，并把它装入到设备控制器中的命令和参数寄存器中，或者相反。由于设备之间的差异很大，每类设备的驱动程序都不相同，故必须由设备制造厂商提供，而不是由 OS 设计者来设计。因此，每当在系统中增加一个新设备时，都需要由安装厂商提供新的驱动程序。
            *   **(3) 设备独立性软件**：现代 OS 中的 I/O 系统基本上都实现了与设备无关性，也称为与设备无关的软件。其基本含义是：I/O 软件独立于具体使用的物理设备。由此带来的最大好处是，提高了 I/O 系统的可适应性和可扩展性，使它们能应用于许多类型的设备，而且在每次增加新设备或替换老设备时，都不需要对 I/O 软件进行修改，这样就方便了系统的更新和扩展。设备独立性软件的内容包括设备命名、设备分配、数据缓冲和数据高速缓冲一类软件等。

---

**6.1.3 I/O 系统接口**

在 I/O 系统与高层之间的接口中，根据设备类型的不同，又进一步分为若干个接口。图 6-2 中示出了块设备接口、流设备接口和网络接口。

1.  **(块设备接口)** *(原文为"2. 块设备接口"，此处调整为与上下文一致的列表项，若原文编号有特定含义，请指出)*
    *   **定义**：块设备管理程序与高层之间的接口。
    *   **反映特性**：大部分磁盘存储器和光盘存储器的本质特征，用于控制该类设备的输入或输出。
    *   **主要内容**：
        *   **(1) 块设备**：指数据的存取和传输都是以数据块为单位的设备。典型的块设备是磁盘。
            *   **基本特征**：传输速率较高 (通常每秒钟为数 MB 到数十 MB)。
            *   **另一特征**：可寻址，即能指定数据的输入源地址及输出的目标地址，可随机地读/写磁盘中任一块。
            *   **I/O 方式**：磁盘设备的 I/O 常采用 DMA 方式。
        *   **(2) 隐藏了磁盘的二维结构**：块设备接口将磁盘上的所有扇区从 0 到 n-1 依次编号 (n 是磁盘中的扇区总数)。经过这样编号后，就把磁盘的二维结构改变为一种线性序列。在二维结构中，每个扇区的地址需要用磁道号和扇区号来表示。或者说，块设备接口隐藏了磁盘地址是二维结构的情况。
        *   **(3) 将抽象命令映射为低层操作**：块设备接口支持上层发来的对文件或设备的打开、读、写和关闭等抽象命令。该接口将上述命令映射为设备能识别的较低层具体操作。例如，上层发来读磁盘命令时，它先将抽象命令中的逻辑块号转换为磁盘的盘面、磁道和扇区等。
    *   **应用**：虚拟存储器系统也需要使用块设备接口，因为在进程运行期间，每当它所访问的页面不在内存时便会发生缺页中断，此时就需要利用 I/O 系统，通过块设备接口从磁盘存储器中将所缺之页面调入内存。

2.  **(流设备接口)** *(原文为"3. 流设备接口")*
    *   **别名**：字符设备接口。
    *   **定义**：流设备管理程序与高层之间的接口。
    *   **反映特性**：大部分字符设备的本质特征，用于控制字符设备的输入或输出。
    *   **主要内容**：
        *   **(1) 字符设备**：指数据的存取和传输是以字符为单位的设备，如键盘、打印机等。
            *   **基本特征**：传输速率较低 (通常为每秒几个字节至数千字节)。
            *   **另一特征**：不可寻址，即不能指定数据的输入源地址及输出的目标地址。
            *   **I/O 方式**：字符设备在输入/输出时，常采用中断驱动方式。
        *   **(2) `get` 和 `put` 操作**：由于字符设备是不可寻址的，因而对它只能采取顺序存取方式。通常是为字符设备建立一个字符缓冲区(队列)，设备的 I/O 字符流顺序地进入字符缓冲区(读入)，或从字符缓冲区顺序地送出到设备(输出)。用户程序获取或输出字符的方法是采用 `get` 和 `put` 操作。
            *   `get` 操作：用于从字符缓冲区取得一个字符(到内存)，将它返回给调用者。
            *   `put` 操作：则用于把一个新字符(从内存)输出到字符缓冲区中，以待送出到设备。
        *   **(3) `in-control` 指令**：因字符设备的类型非常多，且差异甚大，为了以统一的方式来处理它们，通常在流设备接口中提供了一种通用的 `in-control` 指令，在该指令中包含了许多参数，每个参数表示一个与具体设备相关的特定功能。
    *   **共享方式**：由于大多数流设备都属于独占设备，必须采取互斥方式实现共享。为此，流设备接口提供了打开和关闭操作。在使用这类设备时，必须先用打开操作来打开设备。如果设备已被打开，则表示它正被其它进程使用。

3.  **(网络通信接口)** *(原文为"4. 网络通信接口")*
    *   **现状**：在现代 OS 中，都提供了面向网络的功能。
    *   **前提**：
        *   通过某种方式把计算机连接到网络上。
        *   操作系统也必须提供相应的网络软件和网络通信接口，使计算机能通过网络与网络上的其它计算机进行通信或上网浏览。
    *   **复杂性**：由于网络通信接口涉及到许多关于网络方面的知识，如网络中的网络通信协议和网络的层次结构等，故放在第 10.6 节(网络操作系统)中做专门的介绍。
