**引言**
*   **核心功能**：虚拟存储器作为现代操作系统中存储器管理的一项重要技术，实现了**内存扩充功能**。
*   **扩充方式**：并非从物理上实际地扩大内存容量，而是从**逻辑上实现对内存容量的扩充**。
*   **用户感知**：让用户所感觉到的内存容量比实际内存容量大得多。
*   **带来的好处**：
    1.  可以运行比实际内存空间更大的程序。
    2.  可以让更多的用户程序并发运行。
*   **最终效果**：既满足了用户的需要，又改善了系统的性能。
*   **本章目的**：对虚拟存储的有关概念和技术做较详细的阐述。

**传统存储管理方式的问题 (第四章内容回顾)**
*   **共同特点**：都要求将一个作业**全部装入内存后方能运行**。
*   **由此产生的两种情况**：
    1.  **作业过大**：其所要求的内存空间超过了内存总容量，作业不能全部被装入内存，致使该作业无法运行。
    2.  **作业过多**：有大量作业要求运行，但由于内存容量不足以容纳所有这些作业，只能将少数作业装入内存让它们先运行，而将其它大量的作业留在外存上等待。
*   **根本原因**：内存容量不够大。
*   **显而易见的解决方法及其局限性**：
    *   **方法**：从物理上增加内存容量。
    *   **局限性**：往往会受到机器自身的限制，而且无疑要增加系统成本。
*   **虚拟存储技术要解决的核心问题**：从逻辑上扩充内存容量。

---
#### 5.1.1 常规存储管理方式的特征和局部性原理

**1. 常规存储器管理方式的特征**
（前一章介绍的各种存储器管理方式统称为传统存储器管理方式）
它们全都具有如下两个共同的特征：
*   **(1) 一次性**：
    *   **定义**：指作业必须**一次性地全部装入内存后方能开始运行**。
    *   **后果**：
        *   导致大作业无法在小内存中运行。
        *   无法进一步提高系统的多道程序度。
        *   直接限制了对处理机的利用率和系统的吞吐量的提高。
    *   **潜在浪费**：许多作业在运行时，并非需要用到全部程序和数据，如果一次性地装入其全部程序和数据，显然也是对内存空间的一种浪费。
*   **(2) 驻留性**：
    *   **定义**：指作业被装入内存后，**整个作业都一直驻留在内存中**，其中任何部分都不会被换出，直至作业运行结束。
    *   **问题**：尽管运行中的进程会因 I/O 等原因而被阻塞，可能处于长期等待状态，或者有的程序模块在运行过一次后就不再需要(运行)了，它们都仍将驻留在内存中，继续占用宝贵的内存资源。
    *   **结论**：上述的一次性及驻留性特征使得许多在程序运行中不用或暂时不用的程序(数据)占据了大量的内存空间，而一些需要运行的作业又无法装入运行，显然，这是在浪费宝贵的内存资源。
    *   **需要研究的问题**：一次性及驻留性特征是否是程序在运行时所必需的和不可改变的。

**2. 局部性原理**
*   **发现与提出**：程序运行时存在的局部性现象很早就已被人发现，但直到1968年，P.Denning 才真正指出：程序在执行时将呈现出局部性规律。
*   **局部性规律**：即在一较短的时间内，程序的执行仅局限于某个部分，相应地，它所访问的存储空间也局限于某个区域。
*   **Denning 提出的几个论点**：
    *   **(1) 顺序执行性**：程序执行时，除了少部分的转移和过程调用指令外，在大多数情况下是顺序执行的。（此论点在对高级程序设计语言如FORTRAN、PASCAL、C语言规律的研究中被证实）。
    *   **(2) 过程调用的影响**：过程调用将会使程序的执行轨迹由一部分区域转至另一部分区域。但过程调用的深度在大多数情况下都不超过5，这意味着程序将会在一段时间内，都局限在这些过程的范围内运行。
    *   **(3) 循环结构的存在**：程序中存在许多循环结构，这些结构虽然只由少数指令构成，但是它们将被多次执行。
    *   **(4) 数据结构处理的局部性**：程序中还包括许多对数据结构的处理，如对数组进行操作，这些处理往往都局限于很小的范围内。
*   **局部性的表现形式**：
    *   **(1) 时间局限性 (Temporal Locality)**：
        *   **现象**：如果程序中的某条指令被执行，则不久以后该指令可能再次执行；如果某数据被访问过，则不久以后该数据可能再次被访问。
        *   **典型原因**：程序中存在着大量的循环操作。
    *   **(2) 空间局限性 (Spatial Locality)**：
        *   **现象**：一旦程序访问了某个存储单元，在不久之后，其附近的存储单元也将被访问，即程序在一段时间内所访问的地址可能集中在一定的范围之内。
        *   **典型情况**：程序的顺序执行。

**3. 虚拟存储器的基本工作情况**
*   **依据原理**：基于局部性原理。
*   **核心思想**：应用程序在运行之前**没有必要将之全部装入内存**，而仅须将那些当前要运行的少数页面或段先装入内存便可运行，其余部分暂留在盘上。
*   **运行过程**：
    1.  程序在运行时，如果它所要访问的页(段)已调入内存，便可继续执行下去。
    2.  如果程序所要访问的页(段)尚未调入内存（称为**缺页或缺段**），便发出**缺页(段)中断请求**。
    3.  此时 OS 将利用请求调页(段)功能将它们调入内存，以使进程能继续执行下去。
    4.  如果此时内存已满，无法再装入新的页(段)，OS 还须再利用页(段)的**置换功能**，将内存中暂时不用的页(段)调至盘上，腾出足够的内存空间后，再将要访问的页(段)调入内存，使程序继续执行下去。
*   **效果**：
    *   一个大的用户程序可以在较小的内存空间中运行。
    *   可在内存中同时装入更多的进程，使它们并发执行。

---
#### 5.1.2 虚拟存储器的定义和特征

**1. 虚拟存储器的定义**
*   **用户感知**：当用户看到自己的程序能在系统中正常运行时，他会认为，该系统所具有的内存容量一定比自己的程序大，或者说，用户所感觉到的内存容量会比实际内存容量大得多。但用户所看到的大容量只是一种**错觉，是虚的**。
*   **正式定义**：所谓虚拟存储器，是指具有**请求调入功能**和**置换功能**，能从**逻辑上对内存容量加以扩充**的一种存储器系统。
*   **逻辑容量**：其逻辑容量由**内存容量和外存容量之和**所决定。
*   **运行特性**：其运行速度接近于内存速度，而每位的成本却又接近于外存。
*   **地位**：虚拟存储技术是一种性能非常优越的存储器管理技术，故被广泛地应用于大、中、小型机器和微型机中。

**2. 虚拟存储器的特征**
与传统的存储器管理方式比较，虚拟存储器具有以下三个重要特征：
*   **(1) 多次性**：
    *   **相对性**：相对于传统存储器管理方式的“一次性”而言。
    *   **定义**：指一个作业中的程序和数据无需在作业运行时一次性地全部装入内存，而是允许被分成**多次调入内存运行**。即只需将当前要运行的那部分程序和数据装入内存即可开始运行，以后每当要运行到尚未调入的那部分程序时，再将它调入。
    *   **意义**：正是由于虚拟存储器的多次性特征，才使它具有从逻辑上扩大内存的功能。
    *   **重要性**：多次性是虚拟存储器**最重要的特征**，它是任何其它的存储管理方式所不具有的。因此，也可以认为虚拟存储器是具有多次性特征的存储器管理系统。
*   **(2) 对换性**：
    *   **相对性**：相对于传统存储器管理方式的“常驻性”而言。
    *   **定义**：指一个作业中的程序和数据，无须在作业运行时一直常驻内存，而是允许在作业的运行过程中进行**换进、换出**。
    *   **具体操作**：在进程运行期间，允许将那些暂不使用的代码和数据从内存调至外存的对换区(换出)，待以后需要时再将它们从外存调至内存(换进)。甚至还允许将暂时不运行的进程调至外存，待它们重又具备运行条件时再调入内存。
    *   **作用**：换进和换出能有效地提高内存利用率。
    *   **必要性**：如果虚拟存储器不具有换出功能，即不能把那些在存储器中暂时不运行的进程或页面(段)换至外存，不仅不能充分地利用内存，而且还会使在换入时，因无足够的内存空间，而经常以失败告终。
*   **(3) 虚拟性**：
    *   **定义**：指能够从**逻辑上扩充内存容量**，使用户所看到的内存容量远大于实际内存容量。
    *   **带来的好处**：
        *   可以在小的内存中运行大的作业。
        *   能提高多道程序度。
        *   能有效地改善内存的利用率。
        *   可提高程序执行的并发程度，从而可以增加系统的吞吐量。
    *   **意义**：这是虚拟存储器所表现出来的**最重要的特征**，也是实现虚拟存储器的**最重要的目标**。正是由于它具有这一特征，才使得虚拟存储器目前已成为在大、中、小及微机上最广泛采用的存储器管理方式。
*   **特征间的关系**：
    *   虚拟性是以多次性和对换性为基础的。
    *   仅当系统允许将作业分多次调入内存，并能将内存中暂时不运行的程序和数据换至盘上时，才有可能实现虚拟存储器。
    *   多次性和对换性显然又必须建立在离散分配的基础上。

---
#### 5.1.3 虚拟存储器的实现方法
*   **前提**：允许将一个作业分多次调入内存。
*   **连续分配方式的局限**：如果采用连续分配方式时，要求必须将作业装入一个连续的内存区域中，则必须事先为作业一次性地申请一个足以容纳整个作业的内存空间，以便能将该作业分先后地多次装入内存。这不仅会使相当一部分内存空间都处于暂时或“永久”的空闲状态，造成内存资源的严重浪费，而且无法、也无意义再从逻辑上扩大内存容量。
*   **实现基础**：所以，虚拟存储器的实现，都毫无例外地建立在**离散分配存储管理方式的基础上**。
*   **目前主要的实现方式**：
    *   **1. 分页请求系统 (Demand Paging System)**
        *   **基础**：在分页系统的基础上增加了**请求调页功能**和**页面置换功能**所形成的页式虚拟存储系统。
        *   **特点**：允许用户程序只装入少数页面的程序(及数据)即可启动运行。以后，再通过调页功能及页面置换功能陆续地把即将运行的页面调入内存，同时把暂不运行的页面换出到外存上。置换时以**页面为单位**。
        *   **所需支持**：
            *   **1) 硬件支持**：
                *   **(a) 请求分页的页表机制**：在纯分页的页表机制上增加若干项而形成，作为请求分页的数据结构。
                *   **(b) 缺页中断机构**：每当用户程序要访问的页面尚未调入内存时，便产生一缺页中断，以请求 OS 将所缺的页调入内存。
                *   **(c) 地址变换机构**：它同样是在纯分页地址变换机构的基础上发展形成的。
            *   **2) 实现请求分页的软件**：
                *   包括用于实现请求调页的软件和实现页面置换的软件。它们在硬件的支持下，将程序正在运行时所需的页面(尚未在内存中的)调入内存，再将内存中暂时不用的页面从内存置换到磁盘上。
    *   **2. 请求分段系统 (Demand Segmentation System)**
        *   **基础**：在分段系统的基础上，增加了**请求调段及分段置换功能**后所形成的段式虚拟存储系统。
        *   **特点**：允许用户程序只要装入少数段(而非所有的段)的程序和数据即可启动运行。以后通过调段功能和段的置换功能将暂不运行的段调出，再调入即将运行的段。置换时以**段为单位**进行。
        *   **所需支持**：
            *   **1) 硬件支持**：
                *   **(a) 请求分段的段表机制**：它是在纯分段的段表机制上增加若干项而形成的，作为请求分段的数据结构。
                *   **(b) 缺段中断机构**：每当用户程序要访问的段尚未调入内存时，便产生一缺段中断，以请求 OS 将所缺的段调入内存。
                *   **(c) 地址变换机构**：它同样是在纯分段地址变换机构的基础上发展形成的。
            *   **2) 软件支持**：
                *   包括有用于实现请求调段的软件和实现段置换的软件。它们在硬件的支持下，先将内存中暂时不用的段从内存置换到磁盘上，再将程序正在运行时所需的段(尚未在内存中的)调入内存。
        *   **实现难度比较**：
            *   **分页请求系统**：换进和换出的基本单位都是固定大小的页面，所以在实现上要容易些。
            *   **请求分段系统**：换进换出的基本单位是段，其长度是可变的，分段的分配类似于动态分区方式，它在内存分配和回收上都比较复杂。因此虚拟存储器在实现上具有一定难度。
    *   **当前趋势 (段页式虚拟存储器)**：
        *   目前，有不少虚拟存储器是建立在段页式系统基础上的，通过增加请求调页和页面置换功能形成了段页式虚拟存储器系统。
        *   实现虚拟存储器所需支持的硬件集成在处理器芯片上（例如 Intel 80386 及后续芯片）。