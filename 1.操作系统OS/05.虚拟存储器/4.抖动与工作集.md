由于请求分页式虚拟存储器系统的性能优越，在正常运行情况下，它能有效地减少内存碎片，提高处理机的利用率和吞吐量，故是目前最常用的一种系统。但如果在系统中运行的进程太多，进程在运行中会频繁地发生缺页情况，这又会对系统的性能产生很大的影响，故还须对请求分页系统的性能做简单的分析。

### 5.4.1 多道程序度与“抖动”

**1. 多道程序度与处理机的利用率**
*   **期望**：由于虚拟存储器系统能从逻辑上扩大内存，只需装入一个进程的部分程序和数据便可开始运行，故人们希望在系统中能运行更多的进程，即**增加多道程序度**，以提高处理机的利用率。
*   **实际情况 (图5-9)**：
	* ![[Pasted image 20250531134309.png]]
    *   **初始阶段**：随着多道程序度的增加，处理机的利用率急剧增加。
    *   **N<sub>1</sub> 点后**：增速明显减慢。
    *   **N<sub>max</sub> 点**：处理机的利用率达到最大。
    *   **N<sub>max</sub> 点后**：处理机利用率开始缓慢下降。
    *   **N<sub>2</sub> 点后**：若再继续增加进程数，处理机利用率将加速下降并趋于0（N<sub>3</sub>点）。
*   **原因**：后面阶段利用率趋于0的情况，是因为在系统中已发生了 **“抖动”** (Thrashing)**。

**2. 产生“抖动”的原因**
*   **根本原因**：同时在系统中运行的**进程太多**。
*   **直接后果**：由此分配给每一个进程的**物理块太少**，不能满足进程正常运行的基本要求（即无法容纳其工作集）。
*   **表现**：致使每个进程在运行时，频繁地出现缺页，必须请求系统将所缺之页调入内存。
*   **系统行为**：这会使得在系统中排队等待页面调进/调出的进程数目增加。
*   **磁盘影响**：对磁盘的有效访问时间也随之急剧增加，磁盘I/O成为瓶颈。
*   **进程状态**：造成每个进程的大部分时间都用于页面的换进/换出，而几乎不能再去做任何有效的工作。
*   **结果**：从而导致发生处理机的利用率急剧下降并趋于0的情况。
*   **定义**：我们称此时的进程是处于“抖动”状态。

**“抖动”的危害**：“抖动”是在进程运行中出现的严重问题，必须采取相应的措施来解决它。它会导致系统吞吐量急剧下降。

**与物理块分配的关系**：由于“抖动”的发生与系统为进程分配物理块的多少有关，于是有人提出了关于进程 **工作集** 的概念。

### 5.4.2 工作集 (Working Set)

**1. 工作集的基本概念**
*   **缺页率与物理块数的关系 (图5-10)**：
	* ![[Pasted image 20250531134332.png]]
    *   进程发生缺页率与进程所获得的物理块数有关。
    *   缺页率随着所分配物理块数的增加而明显地减少。
    *   当物理块数超过某个数目时，再为进程增加物理块，对缺页率的改善已不明显。
    *   反之，当为某进程所分配的物理块数低于某个数目时，每减少一块，对缺页率的影响都变得十分明显，此时又应为该进程分配更多的物理块。
*   **局部性原理**：基于程序运行时的局部性原理得知，程序在运行期间，对页面的访问是不均匀的，在一段时间内仅局限于较少的页面，在另一段时间内，又可能仅局限于对另一些较少的页面进行访问。这些页面被称为**活跃页面 (Active Pages)**。
*   **工作集理论 (Denning, 1968年)**：如果能够预知程序在某段时间间隔内要访问哪些页面，并将它们调入内存，将会大大降低缺页率，从而可显著地提高处理机的利用率。

**2. 工作集的定义**
*   **定义**：所谓工作集，是指在某段时间间隔 **Δ** 里，进程实际所要访问页面的**集合**。
*   **预知的困难**：我们无法事先预知程序在不同时刻将访问哪些页面。
*   **近似方法**：故仍只有像置换算法那样，用程序的**过去某段时间内的行为**作为程序在**将来某段时间内行为的近似**。
*   **表示**：具体地说，是把某进程在时间 *t* 的工作集记为 **w(t, Δ)**，其中的变量 **Δ** 称为工作集的**“窗口尺寸” (Window Size)**。它指的是在当前执行时刻 *t* 之前的 Δ 个内存访问（或 Δ 时间单位）中所涉及到的页面集合。
*   **图示 (图5-11)**：示出了某进程访问页面的序列和窗口大小分别为3、4、5时的工作集。
	* ![[Pasted image 20250531134357.png]]
    *   例如，引用页序列为 `... 24, 15, 18, 23, 24, 17 ...`
    *   当 Δ = 3 时（窗口包含最近3次访问）：
        *   若当前访问到18，过去3次访问是 (24, 15, 18)，工作集 w(t, 3) = {15, 18, 24}
        *   若当前访问到23，过去3次访问是 (15, 18, 23)，工作集 w(t, 3) = {15, 18, 23}
*   **工作集的性质**：
    *   工作集 w(t, Δ) 是一个**随时间 *t* 动态变化的集合**，其大小和内容都会改变。
    *   工作集的大小 |w(t, Δ)| 是窗口尺寸 Δ 的**非递减函数**，即：
        *|w(t, Δ)| ≤ |w(t, Δ+1)|*
*   **工作集的作用**：为了使进程有效地运行，必须使进程的工作集中的所有页面都在内存中（即常驻集应包含工作集）。如果一个进程的工作集中的某些页面不在内存，则会频繁地发生缺页中断，使进程的运行速度大幅下降。

**3. 工作集与缺页率的关系**
*   **常驻集 (Resident Set)**：指在某时刻进程实际驻留在内存中的页面的集合。
*   **理想情况**：如果一个进程的常驻集**包含**了它的工作集，即 w(t, Δ) ⊆ R(t) (R(t)是该时刻的常驻集)，则该进程在此段时间内发生缺页中断的次数会很少。
*   **抖动情况**：如果常驻集的大小远小于工作集的大小，则进程很容易产生缺页中断，甚至出现抖动。
*   **窗口尺寸 Δ 的选择**：
    *   **Δ 太小**：不能充分反映进程对页面的近期需求情况（局部性范围），导致工作集过小，即使工作集都在内存，缺页率仍然可能较高。
    *   **Δ 太大**：虽然可以更全面地包含近期访问过的页面，降低缺页率，但可能包含一些进程在 Δ 时间段初期访问过但后续不再需要的“陈旧”页面，导致工作集过大，造成内存浪费，降低了系统的多道程序度。
    *   合适的 Δ 应能覆盖大部分的局部性行为，使得工作集能较好地预测近期的页面需求。

### 5.4.3 “抖动”的预防方法
为了保证系统具有较大的吞吐量，必须防止“抖动”的发生。目前已有许多防止“抖动”发生的方法。这些方法几乎都是采用**调节多道程序度**或**调整进程的内存分配**来控制“抖动”发生的。

**1. 采取局部置换策略**
*   **思想**：在页面分配和置换策略中，如果采取的是可变分配方式（或固定分配），为了预防发生“抖动”对整个系统的影响，可以采取**局部置换策略 (Local Replacement)**。
*   **机制**：根据这种策略，当某进程发生缺页时，**只能在分配给该进程自己的内存空间内进行页面置换**，不允许从其它进程的内存空间中“窃取”物理块。
*   **效果**：这样，即使该进程本身发生了“抖动”（因其自身分配的物理块不足以容纳其工作集），其影响也被限制在该进程内部，不会直接导致其他进程的缺页率上升。
*   **局限性**：该方法虽然简单易行，但效果不是很好。因为一个抖动的进程仍然会频繁地占用磁盘I/O资源进行页面换入换出，这会增加磁盘I/O队列的长度，从而间接影响其它进程缺页中断的处理时间，延长其它进程对磁盘的访问时间。

**2. 把工作集算法融入到处理机调度中** (或多道程序度控制中)
*   **背景**：当处理机调度程序（或系统的负载均衡模块）发现处理机利用率低下时，它可能会试图从外存调入一个新作业进入内存，或激活一个已挂起的进程，以期望改善处理机的利用率。
*   **融入工作集算法**：
    *   在决定增加多道程序度（调入新进程或激活进程）之前，系统必须先检查当前所有运行进程的工作集是否都已得到满足（即它们的工作集页面是否大部分都在内存中）。
    *   **如果所有运行进程的工作集都已基本满足**：此时便可以从外存调入新的作业或激活挂起进程，因为这不太可能因资源竞争而显著增加现有进程的缺页率。
    *   **反之，如果有些进程的工作集未被满足（表现为缺页率偏高）**：则系统应首先为那些缺页率居高的作业增加新的物理块（如果可能），而不是调入新的作业或激活进程，以避免加剧内存竞争和抖动。
    *   也可以在进程调度时，优先调度其工作集已在内存中的进程。

**3. 利用“L=S”准则调节缺页率 (或多道程序度)**
*   **提出者与时间**：Denning 于 1980 年提出了 “L=S” 准则来调节多道程序度，从而间接控制缺页率。
*   **L (Mean time between page faults)**：平均缺页间隔时间。L值越大，缺页率越低。
*   **S (Mean page fault service time)**：平均缺页服务时间，即用于置换一个页面（包括可能的写回和调入）所需的时间。
*   **准则分析与调节**：
    *   **L >> S**：说明系统很少发生缺页，CPU在两次缺页间有充足的计算时间，磁盘的能力尚未得到充分的利用。此时可以考虑**增加多道程序度**。
    *   **L < S**：说明系统频繁发生缺页，CPU在两次缺页间几乎没有时间做有效工作，大部分时间在等待I/O，缺页的速度已超过磁盘的处理能力，系统可能处于抖动状态。此时应**减少多道程序度**。
    *   **L ≈ S**：此时，磁盘和处理机都可达到它们较高的利用率，系统运行在一个相对理想的平衡点。
*   **作用**：利用 “L=S” 准则，通过动态调整多道程序度，可以使系统趋向于 L≈S 的状态，从而有效地防止抖动并优化资源利用。

**4. 选择暂停的进程** (作为减少多道程序度的一种手段)
*   **背景**：当根据上述方法（如工作集检查或L=S准则）判断出多道程序度偏高，可能导致或已经发生“抖动”时，系统必须减少当前活动的进程数目。
*   **选择策略**：此时应基于某种原则选择暂停某些当前活动的进程，将它们调出到磁盘上（或将其页面换出），以便把腾出的内存空间分配给缺页率发生偏高的进程，或者缓解整体内存压力。
*   **暂停进程的选择原则 (通常与处理机调度或系统策略相关)**：
    *   首先选择暂停**优先级最低**的进程。
    *   若需要，再选择暂停**占用物理块较多但近期活动较少**的进程。
    *   或者暂停一个**对系统整体性能影响较小、但能释放较多内存**的进程。
    *   也可以是暂停**缺页率极高且无法满足其工作集**的进程（如果局部置换策略下）。
    *   或者暂停**剩余执行时间最多**的批处理型进程等。